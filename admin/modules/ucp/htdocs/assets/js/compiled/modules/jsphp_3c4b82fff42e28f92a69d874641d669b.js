var AnnouncementC=UCPMC.extend({init:function(UCP){var announcement=this;this.announcements={};$(document).bind("staticSettingsFinished",function(event){if(announcement.staticsettings.enabled){announcement.announcements=announcement.staticsettings.announcements;}});},poll:function(data){var announcement=this;if(data.enabled){announcement.announcements=data.announcements;}},contactClickInitiateCallTo:function(did){window.location.replace("tel:"+did);},contactClickInitiateFacetime:function(did){window.location.replace("facetime:"+did);},contactClickOptions:function(type){if(type!="number"||false){return false;}
var options=[{text:_("Call To"),function:"contactClickInitiateCallTo",type:"phone"}];if(navigator.appVersion.indexOf("Mac")!=-1){options.push({text:_("Facetime"),function:"contactClickInitiateFacetime",type:"phone"});}
return options;},showActionDialog:function(type,text,p){var options="",count=0,operation=[],primary="";if(typeof type==="undefined"||typeof text==="undefined"){return;}
primary=(typeof p!=="undefined")?p:"";if(primary.indexOf(",")!=-1){var primaries=primary.split(",");}
if(type=="number"){text=text.replace(/\D/g,"");}
$.each(modules,function(index,module){if(UCP.validMethod(module,"contactClickOptions")){var o=UCP.Modules[module].contactClickOptions(type),selected="";if(o!==false&&Array.isArray(o)){$.each(o,function(k,v){if(typeof primaries!=="undefined"){if(primaries.indexOf(v.type)!=-1){if(primaries.indexOf(v.type)===0){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;}else{options=options+"<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>";}
v.module=module;operation=v;count++;}}else{if((typeof v.type!=="undefined")&&(v.type==primary)){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;v.module=module;operation=v;count++;}}});}}});if(count===0){alert(_("There are no actions for this type"));}else if(count===1){if(UCP.validMethod(operation.module,operation.function)){UCP.Modules[operation.module][operation.function](text);}}else if(count>1){UCP.showDialog(_("Select an Action"),"<select id=\"contactmanageraction\" class=\"form-control\">"+options+"</select><button class=\"btn btn-default\" id=\"initiateaction\" style=\"margin-left: 72px;\">Initiate</button>",115,250,function(){$("#initiateaction").click(function(){var func=$("#contactmanageraction option:selected").data("function"),mod=$("#contactmanageraction option:selected").data("module");if(UCP.validMethod(mod,func)){UCP.closeDialog(function(){UCP.Modules[mod][func](text);});}else{alert(_("Function call does not exist!"));}});});}},display:function(event){var $this=this;$(".clickable").click(function(e){var type=$(this).data("type"),text=$(this).text(),primary=$(this).data("primary");$this.showActionDialog(type,text,primary);});$(".announcement-header th[class!=\"noclick\"]").click(function(){var icon=$(this).children("i"),visible=icon.is(":visible"),direction=icon.hasClass("fa-chevron-down")?"up":"down",type=$(this).data("type"),search=(typeof $.url().param("search")!=="undefined")?"&search="+$.url().param("search"):"",view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"",uadd=null;if(!visible)
{$(".cdr-header th i").addClass("hidden");icon.removeClass("hidden");}
if(direction=="up")
{uadd="&order=asc&orderby="+type+search;icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");}
else
{uadd="&order=desc&orderby="+type+search;icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");}
$(".announcement-header th[class!=\"noclick\"]").off("click");$.pjax({url:"?display=dashboard&mod=announcement"+uadd+view+id,container:"#dashboard-content"});});$("#search-text").keypress(function(e){var code=(e.keyCode?e.keyCode:e.which);if(code==13){$this.search($(this).val());e.preventDefault();}});$("#search-btn").click(function(){$this.search($("#search-text").val());});$("#addannouncement").click(function(e){var description=$("#description").val();if(description=='')
{alert("Invalid description specified");$("#description").focus();return false;}
e.preventDefault();var announcement={entrydest:[],entryext:[],entryannouncementret:[]},$this=this;$("form input,select").not(".special").each(function(i,v){var item=$(v);if(item.prop("id")=='retvm')
{var revtm='';if($("#retvm").is(":checked"))
{revtm='on';}
announcement[item.prop("id")]=revtm;}
else if(item.prop("id")=='allow_skip'||item.prop("id")=='return_ivr'||item.prop("id")=='noanswer')
{var itemvalue='0';if($("#"+item.prop("id")).is(":checked"))
{itemvalue='1';}
announcement[item.prop("id")]=itemvalue;}
else
{announcement[item.prop("id")]=item.val();}});$('.entryext').each(function(){announcement.entryext.push($(this).val());});$('[name^=goto]').each(function(){num=$(this).attr('name').replace('goto','');if(num!='invalid'&&num!='timeout')
{dest=$('[name='+$(this).val()+num+']').val();announcement.entrydest.push(dest);}});$('.entryannouncementret').each(function(){if($(this).is(":checked"))
{entryannouncementret='1';}
else
{entryannouncementret='0';}
announcement.entryannouncementret.push(entryannouncementret);});$('.destdropdown, .destdropdown2').attr("disabled","disabled");$("form input").prop("disabled",true);$(this).text(_("Adding..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=announcement&command=addannouncement",{announcement:announcement},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=announcement",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#editannouncement").click(function(e){var description=$("#description").val();if(description=='')
{alert("Invalid description specified");$("#description").focus();return false;}
e.preventDefault();var announcement={entrydest:[],entryext:[],entryannouncementret:[]},$this=this,id=$("#id").val();$("form input,select").not(".special").each(function(i,v){var item=$(v);if(item.prop("id")=='retvm')
{var revtm='';if($("#retvm").is(":checked"))
{revtm='on';}
announcement[item.prop("id")]=revtm;}
else if(item.prop("id")=='allow_skip'||item.prop("id")=='return_ivr'||item.prop("id")=='noanswer')
{var itemvalue='0';if($("#"+item.prop("id")).is(":checked"))
{itemvalue='1';}
announcement[item.prop("id")]=itemvalue;}
else
{announcement[item.prop("id")]=item.val();}});$('.entryext').each(function(){announcement.entryext.push($(this).val());});$('[name^=goto]').each(function(){num=$(this).attr('name').replace('goto','');if(num!='invalid'&&num!='timeout')
{dest=$('[name='+$(this).val()+num+']').val();announcement.entrydest.push(dest);}});$('.entryannouncementret').each(function(){if($(this).is(":checked"))
{entryannouncementret='1';}
else
{entryannouncementret='0';}
announcement.entryannouncementret.push(entryannouncementret);});$('.destdropdown, .destdropdown2').attr("disabled","disabled");$("form input").prop("disabled",true);$(this).text(_("Updating..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=announcement&command=updateannouncement",{id:id,announcement:announcement},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=announcement",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});bind_dests_double_selects();$('#add_entrie').click(function(){new_entrie='<tr>'+$('#gotoDESTID').parents('tr').html()+'</tr>';id=new Date().getTime();thisrow=$('#announcement_entries > tbody:last').find('tr:last').after(new_entrie.replace(/DESTID/g,id));$('.destdropdown2',$(thisrow).next()).hide();bind_dests_double_selects();});$("#deleteannouncement").click(function(e){e.preventDefault();var id=$("#id").val();if(confirm(_("Are you sure you want to delete this announcement?"))){$("form input").prop("disabled",true);$("#deleteannouncement").text(_("Deleting..."));$("#deleteannouncement").prop("disabled",true);$.post("?quietmode=1&module=announcement&command=deleteannouncement",{id:id},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=announcement",container:"#dashboard-content"});}});}});$(".announcement-item").click(function(){$.pjax({url:"?display=dashboard&mod=announcement&view=editannouncement&id="+$(this).data("announcement")+"&mode=edit",container:"#dashboard-content"});});$(document).off("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]");if($.support.pjax){$(document).on("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]",function(event){var container=$("#dashboard-content");$.pjax.click(event,{container:container});});}
invalid_elements();timeout_elements();$('#invalid_loops').change(invalid_elements);$('#timeout_loops').change(timeout_elements);},search:function(text){var view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"";if(text!==""){$.pjax({url:"?display=dashboard&mod=announcement&search="+encodeURIComponent(text)+view+id,container:"#dashboard-content"});}else{$.pjax({url:"?display=dashboard&mod=announcement"+view+id,container:"#dashboard-content"});}},hide:function(event){$(".clickable").off("click");$(".contact-item").off("click");$("#deleteannouncement").off("click");$("#editAnnouncement input").off("blur");$("#addannouncement, #updateannouncement").off("click");$("#editannouncement");},lookup:function(search,regExp){var o=this.recursiveObjectSearch(search,this.contacts),contact;if(o!==false){contact=this.contacts[o[0]];if(contact!==false){contact.ignore=o[0];contact.key=o[o.length-1];}
return contact;}
return false;},recursiveObjectSearch:function(search,haystack,key,strict,stack){var k,o,pattern=new RegExp(search);for(k in haystack){if(haystack.hasOwnProperty(k)&&haystack[k]!==null){if(typeof stack==="undefined"){stack=[];}
if(typeof haystack[k]==="object"){stack.push(k);o=this.recursiveObjectSearch(search,haystack[k],key,strict,stack);if(o!==false){return stack;}else{stack=[];}}else if(pattern.test(haystack[k])){stack.push(k);return stack;}}}
return false;}});function invalid_elements()
{var invalid_elements=$('#invalid_retry_recording, #invalid_recording, #invalid_append_announce, #invalid_announcement_ret, [name=gotoinvalid]');var invalid_element_tr=invalid_elements.parent();switch($('#invalid_loops').val())
{case'disabled':invalid_elements.attr('disabled','disabled')
invalid_element_tr.hide();$('.invaliddestination').css("display","none");break;case'0':invalid_elements.removeAttr('disabled')
invalid_element_tr.show();$('#invalid_retry_recording').parent().hide();$('#invalid_append_announce').parent().hide();var gotoinvalid=$("#gotoinvalid").val();$('#'+gotoinvalid+"invalid").css("display","block");break;default:invalid_elements.removeAttr('disabled')
invalid_element_tr.show()
break;}}
function timeout_elements()
{var timeout_elements=$('#timeout_retry_recording, #timeout_recording, #timeout_append_announce, #timeout_announcement_ret, [name=gototimeout]');var timeout_element_tr=timeout_elements.parent();switch($('#timeout_loops').val())
{case'disabled':timeout_elements.attr('disabled','disabled')
timeout_element_tr.hide()
$('.timeoutdestination').css("display","none");break;case'0':timeout_elements.removeAttr('disabled')
timeout_element_tr.show();$('#timeout_retry_recording').parent().hide();$('#timeout_append_announce').parent().hide();var gototimeout=$("#gototimeout").val();$('#'+gototimeout+"timeout").css("display","block");default:timeout_elements.removeAttr('disabled')
timeout_element_tr.show()
break;}}
function bind_dests_double_selects()
{$(".destdropdown").unbind().bind("change",function(e){var id=$(this).data("id"),dest=$(this).val();id=(typeof id=="undefined")?"":id;$("[data-id="+id+"].destdropdown2").hide();dd2=$("#"+dest+id+".destdropdown2");cur_val=dd2.show().val();if(dd2.children().length>1&&cur_val=="popover"){dd2.val("");cur_val="";}
if(cur_val=="popover"){dd2.trigger("change");}});}
var CallforwardC=UCPMC.extend({init:function(){},settingsDisplay:function(){$("#module-Callforward form .input-group").each(function(index){$(this).find("input[type=\"text\"]").prop("disabled",!$(this).find("input[type=\"checkbox\"]").is(":checked"));});$("#cfringtimer").change(function(){Callforward.saveSettings({ringtimer:$(this).val()});});$("#module-Callforward .cfnumber input[type=\"text\"]").change(function(){$(this).blur(function(){var el=$(this).prop("name"),id=$(this).prop("id");if($(".cfnumber input[data-el=\""+el+"\"]").is(":checked")){if($(this).val()!==""){Callforward.saveSettings({number:$(this).val(),type:$(this).data("type")});}else{$("#"+id+"_number_enable").click();Callforward.saveSettings({number:"",type:$(this).data("type")});}}
$(this).off("blur");});});$("#module-Callforward .cfnumber input[type=\"checkbox\"]").change(function(){var el=$(this).data("el");if(!$(this).is(":checked")){$("#"+el).prop("disabled",true);if($("#"+el).val()!==""){$("#"+el).val("");Callforward.saveSettings({number:"",type:$("#"+el).data("type")});}}else{$("#"+el).prop("disabled",false);}});},settingsHide:function(){$("#cfringtimer").off("change");$(".cfnumber input[type=\"text\"]").off("change");$(".cfnumber input[type=\"checkbox\"]").off("change");},saveSettings:function(data){data.ext=ext;$.post("index.php?quietmode=1&module=callforward&command=settings",data,function(data){$("#module-Callforward .message").text(data.message).addClass("alert-"+data.alert).fadeIn("fast",function(){$(this).delay(2000).fadeOut("fast",function(){$(".masonry-container").packery();});});$(".masonry-container").packery();});}}),Callforward=new CallforwardC();var CallwaitingC=UCPMC.extend({init:function(){},settingsDisplay:function(){$('#cwenable').change(function(){$.post("index.php?quietmode=1&module=callwaiting&command=enable",{enable:$(this).is(':checked'),ext:ext},function(data){$('#module-Callwaiting .message').text(data.message).addClass('alert-'+data.alert).fadeIn('fast',function(){$(this).delay(2000).fadeOut('fast',function(){$('.masonry-container').packery();});});$('.masonry-container').packery();});});},settingsHide:function(){$('#cwenable').off('change');}});var Callwaiting=new CallwaitingC();var CdrC=UCPMC.extend({init:function(){this.playing=null;},poll:function(data,url){},display:function(event){$(document).on("click","[vm-pjax] a, a[vm-pjax]",function(event){var container=$("#dashboard-content");$.pjax.click(event,{container:container});});$(".clickable").click(function(e){var text=$(this).text();if(UCP.validMethod("Contactmanager","showActionDialog")){UCP.Modules.Contactmanager.showActionDialog("number",text,"phone");}});$(".cdr-header th[class!=\"noclick\"]").click(function(){var icon=$(this).children("i"),visible=icon.is(":visible"),direction=icon.hasClass("fa-chevron-down")?"up":"down",type=$(this).data("type"),search=(typeof $.url().param("search")!=="undefined")?"&search="+$.url().param("search"):"",uadd=null;if(!visible){$(".cdr-header th i").addClass("hidden");icon.removeClass("hidden");}
if(direction=="up"){uadd="&order=asc&orderby="+type+search;icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");}else{uadd="&order=desc&orderby="+type+search;icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");}
$(".cdr-header th[class!=\"noclick\"]").off("click");$.pjax({url:"?display=dashboard&mod=cdr&sub="+$.url().param("sub")+uadd,container:"#dashboard-content"});});$(".subplay").click(function(){var id=$(this).data("msg"),date=$("#cdr-item-"+id+" .date").html(),clid=$("#cdr-item-"+id+" .clid .text").html();if(Cdr.playing===null||Cdr.playing!=id){if(Cdr.playing!==null){$("#jquery_jplayer_"+Cdr.playing).jPlayer("stop",0);}
$("#jquery_jplayer_"+id).jPlayer({ready:function(){$(this).jPlayer("setMedia",{title:clid,wav:"?quietmode=1&module=cdr&command=listen&msgid="+id+"&format=wav&type=playback&ext="+extension,oga:"?quietmode=1&module=cdr&command=listen&msgid="+id+"&format=oga&type=playback&ext="+extension,});},swfPath:"/js",supplied:supportedMediaFormats,cssSelectorAncestor:"#jp_container_"+id}).bind($.jPlayer.event.loadstart,function(event){$("#jp_container_"+id+" .jp-message-window").show();$("#jp_container_"+id+" .jp-message-window .message").css("color","");$("#jp_container_"+id+" .jp-seek-bar").css("background",'url("modules/Cdr/assets/images/jplayer.blue.monday.seeking.gif") 0 0 repeat-x');});$("#cdr-playback-"+id+" .title-text").html(date+" "+clid);$(".cdr-playback").slideUp("fast");$("#cdr-playback-"+id).slideDown("fast",function(){$("#jquery_jplayer_"+id).bind($.jPlayer.event.error,function(event){$("#jp_container_"+id+" .jp-message-window").show();$("#jp_container_"+id+" .message").text(event.jPlayer.error.message).css("color","red");$("#jp_container_"+id+" .jp-seek-bar").css("background","");});$("#jquery_jplayer_"+id).bind($.jPlayer.event.canplay,function(event){$(".jp-message-window").fadeOut("fast");$("#jp_container_"+id+" .jp-seek-bar").css("background","");});$("#jquery_jplayer_"+id).bind($.jPlayer.event.play,function(event){$("#cdr-item-"+id+" .subplay i").removeClass("fa-play").addClass("fa-pause");});$("#jquery_jplayer_"+id).bind($.jPlayer.event.pause,function(event){$("#cdr-item-"+id+" .subplay i").removeClass("fa-pause").addClass("fa-play");});$("#jquery_jplayer_"+id).bind($.jPlayer.event.stop,function(event){$("#cdr-item-"+id+" .subplay i").removeClass("fa-pause").addClass("fa-play");});$("#jquery_jplayer_"+id).jPlayer("play",0);});Cdr.playing=id;}else{if($("#cdr-item-"+Cdr.playing+" .subplay i").hasClass("fa-pause")){$("#jquery_jplayer_"+Cdr.playing).jPlayer("pause");}else{$("#jquery_jplayer_"+Cdr.playing).jPlayer("play");}}});$("#search-text").keypress(function(e){var code=(e.keyCode?e.keyCode:e.which);if(code==13){Cdr.search($(this).val());e.preventDefault();}});$("#search-btn").click(function(){Cdr.search($("#search-text").val());});},search:function(text){if(text!==""){$.pjax({url:"?display=dashboard&mod=cdr&search="+encodeURIComponent(text)+"&sub="+$.url().param("sub"),container:"#dashboard-content"});}else{$.pjax({url:"?display=dashboard&mod=cdr&sub="+$.url().param("sub"),container:"#dashboard-content"});}},hide:function(event){$(document).off("click","[vm-pjax] a, a[vm-pjax]");$(".clickable").off("click");if(Cdr.playing!==null){$("#jquery_jplayer_"+Cdr.playing).jPlayer("stop",0);Cdr.playing=null;}},windowState:function(state){},saveSettings:function(data){data.conference=conference;$.post("index.php?quietmode=1&module=conferencespro&command=settings",data,function(data){$(".conferencesettings #message").text(data.message).addClass("alert-"+data.alert).fadeIn("fast",function(){$(this).delay(5000).fadeOut("fast");});});}}),Cdr=new CdrC();var ContactmanagerC=UCPMC.extend({init:function(UCP){var cm=this;this.contacts={};$(document).bind("staticSettingsFinished",function(event){if(cm.staticsettings.enabled){cm.contacts=cm.staticsettings.contacts;}});},poll:function(data){var cm=this;if(data.enabled){cm.contacts=data.contacts;}},contactClickInitiateCallTo:function(did){window.location.replace("tel:"+did);},contactClickInitiateFacetime:function(did){window.location.replace("facetime:"+did);},contactClickOptions:function(type){if(type!="number"||false){return false;}
var options=[{text:_("Call To"),function:"contactClickInitiateCallTo",type:"phone"}];if(navigator.appVersion.indexOf("Mac")!=-1){options.push({text:_("Facetime"),function:"contactClickInitiateFacetime",type:"phone"});}
return options;},showActionDialog:function(type,text,p){var options="",count=0,operation=[],primary="";if(typeof type==="undefined"||typeof text==="undefined"){return;}
primary=(typeof p!=="undefined")?p:"";if(primary.indexOf(",")!=-1){var primaries=primary.split(",");}
if(type=="number"){text=text.replace(/\D/g,"");}
$.each(modules,function(index,module){if(UCP.validMethod(module,"contactClickOptions")){var o=UCP.Modules[module].contactClickOptions(type),selected="";if(o!==false&&Array.isArray(o)){$.each(o,function(k,v){if(typeof primaries!=="undefined"){if(primaries.indexOf(v.type)!=-1){if(primaries.indexOf(v.type)===0){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;}else{options=options+"<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>";}
v.module=module;operation=v;count++;}}else{if((typeof v.type!=="undefined")&&(v.type==primary)){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;v.module=module;operation=v;count++;}}});}}});if(count===0){alert(_("There are no actions for this type"));}else if(count===1){if(UCP.validMethod(operation.module,operation.function)){UCP.Modules[operation.module][operation.function](text);}}else if(count>1){UCP.showDialog(_("Select an Action"),"<select id=\"contactmanageraction\" class=\"form-control\">"+options+"</select><button class=\"btn btn-default\" id=\"initiateaction\" style=\"margin-left: 72px;\">Initiate</button>",115,250,function(){$("#initiateaction").click(function(){var func=$("#contactmanageraction option:selected").data("function"),mod=$("#contactmanageraction option:selected").data("module");if(UCP.validMethod(mod,func)){UCP.closeDialog(function(){UCP.Modules[mod][func](text);});}else{alert(_("Function call does not exist!"));}});});}},display:function(event){var $this=this;$(".clickable").click(function(e){var type=$(this).data("type"),text=$(this).text(),primary=$(this).data("primary");$this.showActionDialog(type,text,primary);});$(".contact-header th[class!=\"noclick\"]").click(function(){var icon=$(this).children("i"),visible=icon.is(":visible"),direction=icon.hasClass("fa-chevron-down")?"up":"down",type=$(this).data("type"),search=(typeof $.url().param("search")!=="undefined")?"&search="+$.url().param("search"):"",view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"",uadd=null;if(!visible){$(".cdr-header th i").addClass("hidden");icon.removeClass("hidden");}
if(direction=="up"){uadd="&order=asc&orderby="+type+search;icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");}else{uadd="&order=desc&orderby="+type+search;icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");}
$(".contact-header th[class!=\"noclick\"]").off("click");$.pjax({url:"?display=dashboard&mod=contactmanager"+uadd+view+id,container:"#dashboard-content"});});$("#search-text").keypress(function(e){var code=(e.keyCode?e.keyCode:e.which);if(code==13){$this.search($(this).val());e.preventDefault();}});$("#search-btn").click(function(){$this.search($("#search-text").val());});$(".add-additional").click(function(e){e.preventDefault();var type=$(this).data("type");$("."+type+" table").append("<tr>"+$("."+type+" .template").html()+"</tr>");});$("#addContact .additional").on("click",".delete",function(){$(this).parents("tr").remove();});$("#editContact .additional").on("click",".delete",function(){var table=$(this).parents("table"),count=0,type=table.data("type"),data=[],id=$("#id").val();$(this).parents("tr").remove();table.find("tr").not(".template").find("input").each(function(i,v){var obj={};obj[$(this).data("name")]=$(this).val();data.push(obj);});$.post("?quietmode=1&module=contactmanager&command=updatecontact",{id:id,key:type,value:data},function(data){if(data.status){$(".alert").text(data.message).addClass("alert-success").fadeIn("fast",function(){$(this).delay(2000).fadeOut("fast");});}});});$("#editcontactpage").click(function(e){e.preventDefault();var id=$("#id").val(),groupid=$.url().param("group");$.pjax({url:"?display=dashboard&mod=contactmanager&view=contact&group="+groupid+"&id="+id+"&mode=edit",container:"#dashboard-content"});});$("#deletecontact").click(function(e){e.preventDefault();var id=$("#id").val(),groupid=$.url().param("group");if(confirm(_("Are you sure you want to delete this contact?"))){$("form input").prop("disabled",true);$("#deletecontact").text(_("Deleting..."));$("#deletecontact").prop("disabled",true);$.post("?quietmode=1&module=contactmanager&command=deletecontact",{id:id},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=contactmanager&view=group&id="+groupid,container:"#dashboard-content"});}});}});$("#editContact input").not(".special").not(".specialn").blur(function(e){var key=$(this).prop("id"),value=$(this).val(),id=$("#id").val();$.post("?quietmode=1&module=contactmanager&command=updatecontact",{id:id,key:key,value:value},function(data){if(data.status){$(".alert").text(data.message).addClass("alert-success").fadeIn("fast",function(){$(this).delay(2000).fadeOut("fast");});}});});$("#editContact .numbers").on("blur","input",function(e){var table=$(this).parents("table"),count=0,type=table.data("type"),data=[],id=$("#id").val();$(".numbers tr").filter(":visible").each(function(i,v){var obj={};obj.number=$(this).find("input[data-name='number']").val();obj.type=$(this).find("select[data-name='type']").val();data.push(obj);});$.post("?quietmode=1&module=contactmanager&command=updatecontact",{id:id,key:type,value:data},function(data){if(data.status){$(".alert").text(data.message).addClass("alert-success").fadeIn("fast",function(){$(this).delay(2000).fadeOut("fast");});}});});$("#editContact .numbers").on("change","select",function(e){var table=$(this).parents("table"),count=0,type=table.data("type"),data=[],id=$("#id").val();$(".numbers tr").filter(":visible").each(function(i,v){var obj={};obj.number=$(this).find("input[data-name='number']").val();obj.type=$(this).find("select[data-name='type']").val();data.push(obj);});$.post("?quietmode=1&module=contactmanager&command=updatecontact",{id:id,key:type,value:data},function(data){if(data.status){$(".alert").text(data.message).addClass("alert-success").fadeIn("fast",function(){$(this).delay(2000).fadeOut("fast");});}});});$("#editContact").on("blur","input[class*='special']",function(e){var table=$(this).parents("table"),count=0,type=table.data("type"),data=[],id=$("#id").val();table.find("tr").not(".template").find("input").each(function(i,v){var obj={};obj[$(this).data("name")]=$(this).val();data.push(obj);});$.post("?quietmode=1&module=contactmanager&command=updatecontact",{id:id,key:type,value:data},function(data){if(data.status){$(".alert").text(data.message).addClass("alert-success").fadeIn("fast",function(){$(this).delay(2000).fadeOut("fast");});}});});$("#addcontact").click(function(e){e.preventDefault();var id=$.url().param("group"),contact={numbers:[]},$this=this;$("form input").not(".special").each(function(i,v){var item=$(v);contact[item.prop("id")]=item.val();});$(".numbers tr").filter(":visible").each(function(i,v){var obj={};obj.number=$(this).find("input[data-name='number']").val();obj.type=$(this).find("select[data-name='type']").val();contact.numbers.push(obj);});$("form input").filter(":visible").filter(".special").each(function(i,v){var table=$(this).parents("table"),type=table.data("type"),data=[];table.find("tr").not(".template").find("input").each(function(i,v){var obj={};obj[$(this).data("name")]=$(this).val();data.push(obj);});contact[type]=data;});$("form input").prop("disabled",true);$(this).text(_("Adding..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=contactmanager&command=addcontact",{id:id,contact:contact},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=contactmanager&view=group&id="+id,container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#deletegroup").click(function(e){e.preventDefault();if(confirm(_("Are you sure you want to delete this group and all of it's contacts?"))){$.post("?quietmode=1&module=contactmanager&command=deletegroup",{id:$(this).data("id")},function(data){if(data.status){$(".contact-group[data-name='"+data.name+"']").remove();$.pjax({url:"?display=dashboard&mod=contactmanager",container:"#dashboard-content"});}});}});$("#addgroup").click(function(e){var groupid=1,groupname=$("#name").val();e.preventDefault();if($(".contact-group[data-name='"+groupname+"']").length){alert(_("Group Already Exists"));$("#name").focus();return false;}
if(groupname===""){alert(_("Group Name Can Not Be Blank"));$("#name").focus();return false;}
$.post("?quietmode=1&module=contactmanager&command=addgroup",{name:groupname},function(data){if(data.status){$(".contact-group:last").after('<div class="contact-group sub" data-name="'+groupname+'"><a cm-pjax href="?display=dashboard&amp;mod=contactmanager&amp;view=group&amp;id='+data.id+'" class="contact-group-inner">'+groupname+'<span class="badge">0</span></a></div>');$("#name").val("");$.pjax({url:"?display=dashboard&mod=contactmanager&view=group&id="+data.id,container:"#dashboard-content"});}});});$(".contact-item").click(function(){$.pjax({url:"?display=dashboard&mod=contactmanager&view=contact&group="+$(this).data("group")+"&id="+$(this).data("contact"),container:"#dashboard-content"});});$(document).off("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]");if($.support.pjax){$(document).on("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]",function(event){var container=$("#dashboard-content");$.pjax.click(event,{container:container});});}},search:function(text){var view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"";if(text!==""){$.pjax({url:"?display=dashboard&mod=contactmanager&search="+encodeURIComponent(text)+view+id,container:"#dashboard-content"});}else{$.pjax({url:"?display=dashboard&mod=contactmanager"+view+id,container:"#dashboard-content"});}},hide:function(event){$(".clickable").off("click");$(".contact-item").off("click");$("#addgroup").off("click");$("#deletegroup").off("click");$("#deletecontact").off("click");$("#editContact input").off("blur");$("#addcontact, #updatecontact").off("click");$("#editcontact");},lookup:function(search,regExp){var o=this.recursiveObjectSearch(search,this.contacts),contact;if(o!==false){contact=this.contacts[o[0]];if(contact!==false){contact.ignore=o[0];contact.key=o[o.length-1];}
return contact;}
return false;},recursiveObjectSearch:function(search,haystack,key,strict,stack){var k,o,pattern=new RegExp(search);for(k in haystack){if(haystack.hasOwnProperty(k)&&haystack[k]!==null){if(typeof stack==="undefined"){stack=[];}
if(typeof haystack[k]==="object"){stack.push(k);o=this.recursiveObjectSearch(search,haystack[k],key,strict,stack);if(o!==false){return stack;}else{stack=[];}}else if(pattern.test(haystack[k])){stack.push(k);return stack;}}}
return false;}});var DonotdisturbC=UCPMC.extend({init:function(){},settingsDisplay:function(){$('#dndenable').change(function(){$.post("index.php?quietmode=1&module=donotdisturb&command=enable",{enable:$(this).is(':checked'),ext:ext},function(data){$('#module-Donotdisturb .message').text(data.message).addClass('alert-'+data.alert).fadeIn('fast',function(){$(this).delay(5000).fadeOut('fast',function(){$('.masonry-container').packery();});});$('.masonry-container').packery();});});},settingsHide:function(){$('#dndenable').off('change');}});var Donotdisturb=new DonotdisturbC();var FindmefollowC=UCPMC.extend({init:function(){},settingsDisplay:function(){$('#module-Findmefollow input[type="text"], #module-Findmefollow textarea').change(function(){$(this).blur(function(){Findmefollow.saveSettings({key:$(this).prop('name'),value:$(this).val()});$(this).off('blur');});});$('#module-Findmefollow input[type="checkbox"]').change(function(){Findmefollow.saveSettings({key:$(this).prop('name'),value:$(this).is(':checked')});});$('#module-Findmefollow select').change(function(){Findmefollow.saveSettings({key:$(this).prop('name'),value:$(this).val()});});},settingsHide:function(){$('#module-Findmefollow input[type="text"], #module-Findmefollow textarea').off('change');$('#module-Findmefollow input[type="checkbox"]').off('change');$('#module-Findmefollow select').off('change');},saveSettings:function(data){data.ext=ext;$.post("index.php?quietmode=1&module=findmefollow&command=settings",data,function(data){$('#module-Findmefollow .message').text(data.message).addClass('alert-'+data.alert).fadeIn('fast',function(){$(this).delay(5000).fadeOut('fast',function(){$('.masonry-container').packery();});});$('.masonry-container').packery();});}});var Findmefollow=new FindmefollowC();var HomeC=UCPMC.extend({init:function(){this.packery=false;this.doit=null;},poll:function(data){},display:function(event){$(window).on("resize.Home",Home.resize);this.resize();},hide:function(event){$(window).off("resize.Home");this.packery=false;},refresh:function(module,id){$("#"+module+"-title-"+id+" i.fa-refresh").addClass("fa-spin");$.post("?quietmode=1&module="+module+"&command=homeRefresh&id="+id,{},function(data){$("#"+module+"-title-"+id+" i.fa-refresh").removeClass("fa-spin");$("#"+module+"-content-"+id).html(data.content);});},resize:function(){var wasPackeryEnabled=this.packery;this.packery=$(window).width()>=768;if(this.packery!==wasPackeryEnabled){if(this.packery){clearTimeout(this.doit);this.doit=setTimeout(function(){$(".widget").css("width","33.33%");$(".widget").css("margin-bottom","");$(".masonry-container").packery({columnWidth:40,gutter:10,itemSelector:".widget"});},100);}else{this.packery=false;$(".masonry-container").packery("destroy");$(".widget").css("width","100%");$(".widget").css("margin-bottom","10px");}}else if(!this.packery){$(".widget").css("width","100%");$(".widget").css("margin-bottom","10px");}}}),Home=new HomeC();var InboundsettingsC=UCPMC.extend({init:function(UCP){var cm=this;this.dids={};$(document).bind("staticSettingsFinished",function(event){if(cm.staticsettings.enabled){cm.dids=cm.staticsettings.dids;}});},poll:function(data){var cm=this;if(data.enabled){cm.dids=data.dids;}},didClickInitiateCallTo:function(did){window.location.replace("tel:"+did);},didClickInitiateFacetime:function(did){window.location.replace("facetime:"+did);},didClickOptions:function(type){if(type!="number"||false){return false;}
var options=[{text:_("Call To"),function:"didClickInitiateCallTo",type:"phone"}];if(navigator.appVersion.indexOf("Mac")!=-1){options.push({text:_("Facetime"),function:"didClickInitiateFacetime",type:"phone"});}
return options;},showActionDialog:function(type,text,p){var options="",count=0,operation=[],primary="";if(typeof type==="undefined"||typeof text==="undefined"){return;}
primary=(typeof p!=="undefined")?p:"";if(primary.indexOf(",")!=-1){var primaries=primary.split(",");}
if(type=="number"){text=text.replace(/\D/g,"");}
$.each(modules,function(index,module){if(UCP.validMethod(module,"didClickOptions")){var o=UCP.Modules[module].didClickOptions(type),selected="";if(o!==false&&Array.isArray(o)){$.each(o,function(k,v){if(typeof primaries!=="undefined"){if(primaries.indexOf(v.type)!=-1){if(primaries.indexOf(v.type)===0){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;}else{options=options+"<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>";}
v.module=module;operation=v;count++;}}else{if((typeof v.type!=="undefined")&&(v.type==primary)){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;v.module=module;operation=v;count++;}}});}}});if(count===0){alert(_("There are no actions for this type"));}else if(count===1){if(UCP.validMethod(operation.module,operation.function)){UCP.Modules[operation.module][operation.function](text);}}else if(count>1){UCP.showDialog(_("Select an Action"),"<select id=\"didmanageraction\" class=\"form-control\">"+options+"</select><button class=\"btn btn-default\" id=\"initiateaction\" style=\"margin-left: 72px;\">Initiate</button>",115,250,function(){$("#initiateaction").click(function(){var func=$("#didmanageraction option:selected").data("function"),mod=$("#didmanageraction option:selected").data("module");if(UCP.validMethod(mod,func)){UCP.closeDialog(function(){UCP.Modules[mod][func](text);});}else{alert(_("Function call does not exist!"));}});});}},display:function(event){var $this=this;$(".clickable").click(function(e){var type=$(this).data("type"),text=$(this).text(),primary=$(this).data("primary");$this.showActionDialog(type,text,primary);});$(".did-header th[class!=\"noclick\"]").click(function(){var icon=$(this).children("i"),visible=icon.is(":visible"),direction=icon.hasClass("fa-chevron-down")?"up":"down",type=$(this).data("type"),search=(typeof $.url().param("search")!=="undefined")?"&search="+$.url().param("search"):"",view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"",uadd=null;if(!visible){$(".cdr-header th i").addClass("hidden");icon.removeClass("hidden");}
if(direction=="up"){uadd="&order=asc&orderby="+type+search;icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");}else{uadd="&order=desc&orderby="+type+search;icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");}
$(".did-header th[class!=\"noclick\"]").off("click");$.pjax({url:"?display=dashboard&mod=inboundsettings"+uadd+view+id,container:"#dashboard-content"});});$("#search-text").keypress(function(e){var code=(e.keyCode?e.keyCode:e.which);if(code==13){$this.search($(this).val());e.preventDefault();}});$("#search-btn").click(function(){$this.search($("#search-text").val());});$("#adddidbutton").click(function(e){e.preventDefault();var did={entrydest:[],entryext:[],entryivrret:[]},$this=this,id=$("#id").val();$("form input,select").not(".special").each(function(i,v){var item=$(v);did[item.prop("id")]=item.val();});$("form input").prop("disabled",true);$(this).text(_("Adding..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=inboundsettings&command=adddid",{id:id,did:did},function(data){if(data.status)
{$.pjax({url:"?display=dashboard&mod=inboundsettings",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#editdidbutton").click(function(e){e.preventDefault();var did={entrydest:[],entryext:[],entryivrret:[]},$this=this,id=$("#id").val();$("form input,select").not(".special").each(function(i,v){var item=$(v);did[item.prop("id")]=item.val();});$("form input").prop("disabled",true);$(this).text(_("Updating..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=inboundsettings&command=updatedid",{id:id,did:did},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=inboundsettings",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#deletedid").click(function(e){e.preventDefault();var id=$("#id").val();if(confirm(_("Are you sure you want to delete this DID?")))
{$("form input").prop("disabled",true);$("#deletedid").text(_("Deleting..."));$("#deletedid").prop("disabled",true);$.post("?quietmode=1&module=inboundsettings&command=deletedid",{id:id},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=inboundsettings",container:"#dashboard-content"});}});}});$(".did-item").click(function(){$.pjax({url:"?display=dashboard&mod=inboundsettings&view=editdid&id="+$(this).data("did")+"&mode=edit",container:"#dashboard-content"});});$(document).off("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]");if($.support.pjax){$(document).on("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]",function(event){var container=$("#dashboard-content");$.pjax.click(event,{container:container});});}},search:function(text){var view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"";if(text!==""){$.pjax({url:"?display=dashboard&mod=inboundsettings&search="+encodeURIComponent(text)+view+id,container:"#dashboard-content"});}else{$.pjax({url:"?display=dashboard&mod=inboundsettings"+view+id,container:"#dashboard-content"});}},hide:function(event){$(".clickable").off("click");$(".contact-item").off("click");$("#addgroup").off("click");$("#deletegroup").off("click");$("#deletecontact").off("click");$("#editContact input").off("blur");$("#addcontact, #updatecontact").off("click");$("#editcontact");},lookup:function(search,regExp){var o=this.recursiveObjectSearch(search,this.contacts),contact;if(o!==false){contact=this.contacts[o[0]];if(contact!==false){contact.ignore=o[0];contact.key=o[o.length-1];}
return contact;}
return false;},recursiveObjectSearch:function(search,haystack,key,strict,stack){var k,o,pattern=new RegExp(search);for(k in haystack){if(haystack.hasOwnProperty(k)&&haystack[k]!==null){if(typeof stack==="undefined"){stack=[];}
if(typeof haystack[k]==="object"){stack.push(k);o=this.recursiveObjectSearch(search,haystack[k],key,strict,stack);if(o!==false){return stack;}else{stack=[];}}else if(pattern.test(haystack[k])){stack.push(k);return stack;}}}
return false;}});var InboundsettingsC=UCPMC.extend({init:function(UCP){var cm=this;this.dids={};$(document).bind("staticSettingsFinished",function(event){if(cm.staticsettings.enabled){cm.dids=cm.staticsettings.dids;}});},poll:function(data){var cm=this;if(data.enabled){cm.dids=data.dids;}},didClickInitiateCallTo:function(did){window.location.replace("tel:"+did);},didClickInitiateFacetime:function(did){window.location.replace("facetime:"+did);},didClickOptions:function(type){if(type!="number"||false){return false;}
var options=[{text:_("Call To"),function:"didClickInitiateCallTo",type:"phone"}];if(navigator.appVersion.indexOf("Mac")!=-1){options.push({text:_("Facetime"),function:"didClickInitiateFacetime",type:"phone"});}
return options;},showActionDialog:function(type,text,p){var options="",count=0,operation=[],primary="";if(typeof type==="undefined"||typeof text==="undefined"){return;}
primary=(typeof p!=="undefined")?p:"";if(primary.indexOf(",")!=-1){var primaries=primary.split(",");}
if(type=="number"){text=text.replace(/\D/g,"");}
$.each(modules,function(index,module){if(UCP.validMethod(module,"didClickOptions")){var o=UCP.Modules[module].didClickOptions(type),selected="";if(o!==false&&Array.isArray(o)){$.each(o,function(k,v){if(typeof primaries!=="undefined"){if(primaries.indexOf(v.type)!=-1){if(primaries.indexOf(v.type)===0){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;}else{options=options+"<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>";}
v.module=module;operation=v;count++;}}else{if((typeof v.type!=="undefined")&&(v.type==primary)){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;v.module=module;operation=v;count++;}}});}}});if(count===0){alert(_("There are no actions for this type"));}else if(count===1){if(UCP.validMethod(operation.module,operation.function)){UCP.Modules[operation.module][operation.function](text);}}else if(count>1){UCP.showDialog(_("Select an Action"),"<select id=\"didmanageraction\" class=\"form-control\">"+options+"</select><button class=\"btn btn-default\" id=\"initiateaction\" style=\"margin-left: 72px;\">Initiate</button>",115,250,function(){$("#initiateaction").click(function(){var func=$("#didmanageraction option:selected").data("function"),mod=$("#didmanageraction option:selected").data("module");if(UCP.validMethod(mod,func)){UCP.closeDialog(function(){UCP.Modules[mod][func](text);});}else{alert(_("Function call does not exist!"));}});});}},display:function(event){var $this=this;$(".clickable").click(function(e){var type=$(this).data("type"),text=$(this).text(),primary=$(this).data("primary");$this.showActionDialog(type,text,primary);});$(".did-header th[class!=\"noclick\"]").click(function(){var icon=$(this).children("i"),visible=icon.is(":visible"),direction=icon.hasClass("fa-chevron-down")?"up":"down",type=$(this).data("type"),search=(typeof $.url().param("search")!=="undefined")?"&search="+$.url().param("search"):"",view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"",uadd=null;if(!visible){$(".cdr-header th i").addClass("hidden");icon.removeClass("hidden");}
if(direction=="up"){uadd="&order=asc&orderby="+type+search;icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");}else{uadd="&order=desc&orderby="+type+search;icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");}
$(".did-header th[class!=\"noclick\"]").off("click");$.pjax({url:"?display=dashboard&mod=inboundsettings"+uadd+view+id,container:"#dashboard-content"});});$("#search-text").keypress(function(e){var code=(e.keyCode?e.keyCode:e.which);if(code==13){$this.search($(this).val());e.preventDefault();}});$("#search-btn").click(function(){$this.search($("#search-text").val());});$("#adddidbutton").click(function(e){e.preventDefault();var did={entrydest:[],entryext:[],entryivrret:[]},$this=this,id=$("#id").val();$("form input,select").not(".special").each(function(i,v){var item=$(v);did[item.prop("id")]=item.val();});$("form input").prop("disabled",true);$(this).text(_("Adding..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=inboundsettings&command=adddid",{id:id,did:did},function(data){if(data.status)
{$.pjax({url:"?display=dashboard&mod=inboundsettings",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#editdidbutton").click(function(e){if($('#ivr').val().trim()=='FORWARD'&&$('#forwardnumber').val().trim()==''){alert('Please enter the Forwarding Number.');return false;}
e.preventDefault();var did={entrydest:[],entryext:[],entryivrret:[]},$this=this,id=$("#id").val();$("form input,select").not(".special").each(function(i,v){var item=$(v);did[item.prop("id")]=item.val();});$("form input").prop("disabled",true);$(this).text(_("Updating..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=inboundsettings&command=updatedid",{id:id,did:did},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=inboundsettings",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#deletedid").click(function(e){e.preventDefault();var id=$("#id").val();if(confirm(_("Are you sure you want to delete this DID?")))
{$("form input").prop("disabled",true);$("#deletedid").text(_("Deleting..."));$("#deletedid").prop("disabled",true);$.post("?quietmode=1&module=inboundsettings&command=deletedid",{id:id},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=inboundsettings",container:"#dashboard-content"});}});}});$(".did-item").click(function(){$.pjax({url:"?display=dashboard&mod=inboundsettings&view=editdid&id="+$(this).data("did")+"&mode=edit",container:"#dashboard-content"});});$(document).off("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]");if($.support.pjax){$(document).on("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]",function(event){var container=$("#dashboard-content");$.pjax.click(event,{container:container});});}},search:function(text){var view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"";if(text!==""){$.pjax({url:"?display=dashboard&mod=inboundsettings&search="+encodeURIComponent(text)+view+id,container:"#dashboard-content"});}else{$.pjax({url:"?display=dashboard&mod=inboundsettings"+view+id,container:"#dashboard-content"});}},hide:function(event){$(".clickable").off("click");$(".contact-item").off("click");$("#addgroup").off("click");$("#deletegroup").off("click");$("#deletecontact").off("click");$("#editContact input").off("blur");$("#addcontact, #updatecontact").off("click");$("#editcontact");},lookup:function(search,regExp){var o=this.recursiveObjectSearch(search,this.contacts),contact;if(o!==false){contact=this.contacts[o[0]];if(contact!==false){contact.ignore=o[0];contact.key=o[o.length-1];}
return contact;}
return false;},recursiveObjectSearch:function(search,haystack,key,strict,stack){var k,o,pattern=new RegExp(search);for(k in haystack){if(haystack.hasOwnProperty(k)&&haystack[k]!==null){if(typeof stack==="undefined"){stack=[];}
if(typeof haystack[k]==="object"){stack.push(k);o=this.recursiveObjectSearch(search,haystack[k],key,strict,stack);if(o!==false){return stack;}else{stack=[];}}else if(pattern.test(haystack[k])){stack.push(k);return stack;}}}
return false;}});var IvrC=UCPMC.extend({init:function(UCP){var ivr=this;this.ivrs={};$(document).bind("staticSettingsFinished",function(event){if(ivr.staticsettings.enabled){ivr.ivrs=ivr.staticsettings.ivrs;}});},settingsDisplay:function(){$('#useivr').change(function(){$.post("index.php?quietmode=1&module=ivr&command=enable",{enable:$(this).is(':checked'),ext:ext},function(data){$('#module-Ivr .message').text(data.message).addClass('alert-'+data.alert).fadeIn('fast',function(){$(this).delay(2000).fadeOut('fast',function(){$('.masonry-container').packery();});});$('.masonry-container').packery();});});},settingsHide:function(){$('#useivr').off('change');},poll:function(data){var ivr=this;if(data.enabled){ivr.ivrs=data.ivrs;}},contactClickInitiateCallTo:function(did){window.location.replace("tel:"+did);},contactClickInitiateFacetime:function(did){window.location.replace("facetime:"+did);},contactClickOptions:function(type){if(type!="number"||false){return false;}
var options=[{text:_("Call To"),function:"contactClickInitiateCallTo",type:"phone"}];if(navigator.appVersion.indexOf("Mac")!=-1){options.push({text:_("Facetime"),function:"contactClickInitiateFacetime",type:"phone"});}
return options;},showActionDialog:function(type,text,p){var options="",count=0,operation=[],primary="";if(typeof type==="undefined"||typeof text==="undefined"){return;}
primary=(typeof p!=="undefined")?p:"";if(primary.indexOf(",")!=-1){var primaries=primary.split(",");}
if(type=="number"){text=text.replace(/\D/g,"");}
$.each(modules,function(index,module){if(UCP.validMethod(module,"contactClickOptions")){var o=UCP.Modules[module].contactClickOptions(type),selected="";if(o!==false&&Array.isArray(o)){$.each(o,function(k,v){if(typeof primaries!=="undefined"){if(primaries.indexOf(v.type)!=-1){if(primaries.indexOf(v.type)===0){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;}else{options=options+"<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>";}
v.module=module;operation=v;count++;}}else{if((typeof v.type!=="undefined")&&(v.type==primary)){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;v.module=module;operation=v;count++;}}});}}});if(count===0){alert(_("There are no actions for this type"));}else if(count===1){if(UCP.validMethod(operation.module,operation.function)){UCP.Modules[operation.module][operation.function](text);}}else if(count>1){UCP.showDialog(_("Select an Action"),"<select id=\"contactmanageraction\" class=\"form-control\">"+options+"</select><button class=\"btn btn-default\" id=\"initiateaction\" style=\"margin-left: 72px;\">Initiate</button>",115,250,function(){$("#initiateaction").click(function(){var func=$("#contactmanageraction option:selected").data("function"),mod=$("#contactmanageraction option:selected").data("module");if(UCP.validMethod(mod,func)){UCP.closeDialog(function(){UCP.Modules[mod][func](text);});}else{alert(_("Function call does not exist!"));}});});}},display:function(event){var $this=this;$(".clickable").click(function(e){var type=$(this).data("type"),text=$(this).text(),primary=$(this).data("primary");$this.showActionDialog(type,text,primary);});$(".ivr-header th[class!=\"noclick\"]").click(function(){var icon=$(this).children("i"),visible=icon.is(":visible"),direction=icon.hasClass("fa-chevron-down")?"up":"down",type=$(this).data("type"),search=(typeof $.url().param("search")!=="undefined")?"&search="+$.url().param("search"):"",view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"",uadd=null;if(!visible)
{$(".cdr-header th i").addClass("hidden");icon.removeClass("hidden");}
if(direction=="up")
{uadd="&order=asc&orderby="+type+search;icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");}
else
{uadd="&order=desc&orderby="+type+search;icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");}
$(".ivr-header th[class!=\"noclick\"]").off("click");$.pjax({url:"?display=dashboard&mod=ivr"+uadd+view+id,container:"#dashboard-content"});});$("#search-text").keypress(function(e){var code=(e.keyCode?e.keyCode:e.which);if(code==13){$this.search($(this).val());e.preventDefault();}});$("#search-btn").click(function(){$this.search($("#search-text").val());});$("#addivr").click(function(e){var gotoinvalid=$("#gotoinvalid").val();var gototimeout=$("#gototimeout").val();if(gotoinvalid==''&&$('#invalid_loops').val()!='disabled')
{alert("Please select invalid destination");$("#gotoinvalid").focus();return false;}
if(gototimeout==''&&$('#timeout_loops').val()!='disabled')
{alert("Please select timeout destination");$("#gototimeout").focus();return false;}
e.preventDefault();var ivr={entrydest:[],entryext:[],entryivrret:[]},$this=this;if($('#invalid_loops').val()!='disabled')
{var invalid=$('[name='+$('[name=gotoinvalid]').val()+'invalid]').val();$('#invalid_destination').val(invalid);}
else
{$('#invalid_destination').remove();}
if($('#timeout_loops').val()!='disabled')
{var timeout=$('[name='+$('[name=gototimeout]').val()+'timeout]').val();$('#timeout_destination').val(timeout);}
else
{$('#timeout_destination').remove();}
$("form input,select").not(".special").each(function(i,v){var item=$(v);if(item.prop("id")=='retvm')
{var revtm='';if($("#retvm").is(":checked"))
{revtm='on';}
ivr[item.prop("id")]=revtm;}
else if(item.prop("id")=='invalid_append_announce'||item.prop("id")=='invalid_ivr_ret'||item.prop("id")=='timeout_append_announce'||item.prop("id")=='timeout_ivr_ret'||item.prop("id")=='useivr')
{var itemvalue='0';if($("#"+item.prop("id")).is(":checked"))
{itemvalue='1';}
ivr[item.prop("id")]=itemvalue;}
else
{ivr[item.prop("id")]=item.val();}});$('.entryext').each(function(){ivr.entryext.push($(this).val());});$('[name^=goto]').each(function(){num=$(this).attr('name').replace('goto','');if(num!='invalid'&&num!='timeout')
{dest=$('[name='+$(this).val()+num+']').val();ivr.entrydest.push(dest);}});$('.entryivrret').each(function(){if($(this).is(":checked"))
{entryivrret='1';}
else
{entryivrret='0';}
ivr.entryivrret.push(entryivrret);});$('.destdropdown, .destdropdown2').attr("disabled","disabled");$("form input").prop("disabled",true);$(this).text(_("Adding..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=ivr&command=addivr",{ivr:ivr},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=ivr",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#editivr").click(function(e){var gotoinvalid=$("#gotoinvalid").val();var gototimeout=$("#gototimeout").val();if(gotoinvalid==''&&$('#invalid_loops').val()!='disabled')
{alert("Please select invalid destination");$("#gotoinvalid").focus();return false;}
if(gototimeout==''&&$('#timeout_loops').val()!='disabled')
{alert("Please select timeout destination");$("#gototimeout").focus();return false;}
e.preventDefault();var ivr={entrydest:[],entryext:[],entryivrret:[]},$this=this,id=$("#id").val();if($('#invalid_loops').val()!='disabled')
{var invalid=$('[name='+$('[name=gotoinvalid]').val()+'invalid]').val();$('#invalid_destination').val(invalid);}
else
{$('#invalid_destination').remove();}
if($('#timeout_loops').val()!='disabled')
{var timeout=$('[name='+$('[name=gototimeout]').val()+'timeout]').val();$('#timeout_destination').val(timeout);}
else
{$('#timeout_destination').remove();}
$("form input,select").not(".special").each(function(i,v){var item=$(v);if(item.prop("id")=='retvm')
{var revtm='';if($("#retvm").is(":checked"))
{revtm='on';}
ivr[item.prop("id")]=revtm;}
else if(item.prop("id")=='invalid_append_announce'||item.prop("id")=='invalid_ivr_ret'||item.prop("id")=='timeout_append_announce'||item.prop("id")=='timeout_ivr_ret'||item.prop("id")=='useivr')
{var itemvalue='0';if($("#"+item.prop("id")).is(":checked"))
{itemvalue='1';}
ivr[item.prop("id")]=itemvalue;}
else
{ivr[item.prop("id")]=item.val();}});$('.entryext').each(function(){ivr.entryext.push($(this).val());});$('[name^=goto]').each(function(){num=$(this).attr('name').replace('goto','');if(num!='invalid'&&num!='timeout')
{dest=$('[name='+$(this).val()+num+']').val();ivr.entrydest.push(dest);}});$('.entryivrret').each(function(){if($(this).is(":checked"))
{entryivrret='1';}
else
{entryivrret='0';}
ivr.entryivrret.push(entryivrret);});$('.destdropdown, .destdropdown2').attr("disabled","disabled");$("form input").prop("disabled",true);$(this).text(_("Updating..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=ivr&command=updateivr",{id:id,ivr:ivr},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=ivr",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#deleteivr").click(function(e){e.preventDefault();var id=$("#id").val();if(confirm(_("Are you sure you want to delete this IVR?"))){$("form input").prop("disabled",true);$("#deleteivr").text(_("Deleting..."));$("#deleteivr").prop("disabled",true);$.post("?quietmode=1&module=ivr&command=deleteivr",{id:id},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=ivr",container:"#dashboard-content"});}});}});bind_dests_double_selects();$('#add_entrie').click(function(){new_entrie='<tr>'+$('#gotoDESTID').parents('tr').html()+'</tr>';id=new Date().getTime();thisrow=$('#ivr_entries > tbody:last').find('tr:last').after(new_entrie.replace(/DESTID/g,id));$('.destdropdown2',$(thisrow).next()).hide();bind_dests_double_selects();});$("#ivr_entries").on("click",".delete_entrie",function(){$(this).closest('tr').fadeOut('normal',function(){$(this).closest('tr').remove();})});$(".ivr-item").click(function(){$.pjax({url:"?display=dashboard&mod=ivr&view=editivr&id="+$(this).data("ivr")+"&mode=edit",container:"#dashboard-content"});});$(document).off("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]");if($.support.pjax){$(document).on("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]",function(event){var container=$("#dashboard-content");$.pjax.click(event,{container:container});});}
invalid_elements();timeout_elements();$('#invalid_loops').change(invalid_elements);$('#timeout_loops').change(timeout_elements);},search:function(text){var view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"";if(text!==""){$.pjax({url:"?display=dashboard&mod=ivr&search="+encodeURIComponent(text)+view+id,container:"#dashboard-content"});}else{$.pjax({url:"?display=dashboard&mod=ivr"+view+id,container:"#dashboard-content"});}},hide:function(event){$(".clickable").off("click");$(".contact-item").off("click");$("#addgroup").off("click");$("#deletegroup").off("click");$("#deletecontact").off("click");$("#editContact input").off("blur");$("#addcontact, #updatecontact").off("click");$("#editcontact");},lookup:function(search,regExp){var o=this.recursiveObjectSearch(search,this.contacts),contact;if(o!==false){contact=this.contacts[o[0]];if(contact!==false){contact.ignore=o[0];contact.key=o[o.length-1];}
return contact;}
return false;},recursiveObjectSearch:function(search,haystack,key,strict,stack){var k,o,pattern=new RegExp(search);for(k in haystack){if(haystack.hasOwnProperty(k)&&haystack[k]!==null){if(typeof stack==="undefined"){stack=[];}
if(typeof haystack[k]==="object"){stack.push(k);o=this.recursiveObjectSearch(search,haystack[k],key,strict,stack);if(o!==false){return stack;}else{stack=[];}}else if(pattern.test(haystack[k])){stack.push(k);return stack;}}}
return false;}});function invalid_elements()
{var invalid_elements=$('#invalid_retry_recording, #invalid_recording, #invalid_append_announce, #invalid_ivr_ret, [name=gotoinvalid]');var invalid_element_tr=invalid_elements.parent();switch($('#invalid_loops').val())
{case'disabled':invalid_elements.attr('disabled','disabled')
invalid_element_tr.hide();$('.invaliddestination').css("display","none");break;case'0':invalid_elements.removeAttr('disabled')
invalid_element_tr.show();$('#invalid_retry_recording').parent().hide();$('#invalid_append_announce').parent().hide();var gotoinvalid=$("#gotoinvalid").val();$('#'+gotoinvalid+"invalid").css("display","block");break;default:invalid_elements.removeAttr('disabled')
invalid_element_tr.show()
break;}}
function timeout_elements()
{var timeout_elements=$('#timeout_retry_recording, #timeout_recording, #timeout_append_announce, #timeout_ivr_ret, [name=gototimeout]');var timeout_element_tr=timeout_elements.parent();switch($('#timeout_loops').val())
{case'disabled':timeout_elements.attr('disabled','disabled')
timeout_element_tr.hide()
$('.timeoutdestination').css("display","none");break;case'0':timeout_elements.removeAttr('disabled')
timeout_element_tr.show();$('#timeout_retry_recording').parent().hide();$('#timeout_append_announce').parent().hide();var gototimeout=$("#gototimeout").val();$('#'+gototimeout+"timeout").css("display","block");default:timeout_elements.removeAttr('disabled')
timeout_element_tr.show()
break;}}
function bind_dests_double_selects()
{$(".destdropdown").unbind().bind("change",function(e){var id=$(this).data("id"),dest=$(this).val();id=(typeof id=="undefined")?"":id;$("[data-id="+id+"].destdropdown2").hide();dd2=$("#"+dest+id+".destdropdown2");cur_val=dd2.show().val();if(dd2.children().length>1&&cur_val=="popover"){dd2.val("");cur_val="";}
if(cur_val=="popover"){dd2.trigger("change");}});}
var PresencestateC=UCPMC.extend({init:function(){this.presenceStates={};this.presenceSpecials={startSessionStatus:null,endSessionStatus:null};this.menu=null;this.transitioning=false;this.calibrated=false;},poll:function(data){if(data.status){var stateHTML="";this.menu=data.menu;this.changeStatus(data.presence.State,data.presence.Message);this.buildMenu(false);}},display:function(event){$(".pssettings select").change(function(){Presencestate.savePSSettings();});},hide:function(event){},changeStatus:function(type,message){message=(message!=="")?"("+message+")":"";if(typeof this.menu.representations!=="undefined"&&typeof this.menu.representations[type]!=="undefined"){if($("#nav-btn-presencestate .p-msg span").text()!=this.menu.representations[type].name+" "+message){$("#nav-btn-presencestate .icon i").css("color",this.menu.representations[type].color);$("#nav-btn-presencestate .p-msg span").text(this.menu.representations[type].name+" "+message);$("#nav-btn-presencestate .p-msg").textfill();$(window).trigger("presenceStateChange");}}else{$("#nav-btn-presencestate .p-msg span").text(_("Status Not Set","presencestate"));$("#nav-btn-presencestate .p-msg").textfill();}},buildMenu:function(loggedIn){var menu=Presencestate.menu;if(menu!==null&&menu.status){Presencestate.presenceSpecials.startSessionStatus=menu.startsessionstatus;Presencestate.presenceSpecials.endSessionStatus=menu.endsessionstatus;if(loggedIn&&Presencestate.presenceSpecials.startSessionStatus!==null){$.post("index.php?quietmode=1&module=presencestate&command=set",{state:Presencestate.presenceSpecials.startSessionStatus.id},function(data){Presencestate.changeStatus(data.State,data.Message);Presencestate.buildMenu(false);});}
$("#presencestate-menu .statuses").html(menu.html);$("#presencestate-menu .presence-item").one("click",function(){$("#presencestate-menu .presence-item").css("cursor","not-allowed");$("#presencestate-menu .statuses").css("opacity","0.5");var id=$(this).data("id");if(id!==0){$.post("index.php?quietmode=1&module=presencestate&command=set",{state:id},function(data){Presencestate.menu=data.poller.menu;Presencestate.changeStatus(data.State,data.Message);Presencestate.buildMenu(false);$("#presencestate-menu .presence-item").css("cursor","pointer");$("#presencestate-menu .statuses").css("opacity","1");});}});if(!$("#nav-btn-presencestate").is(":visible")){$("#nav-btn-presencestate").fadeIn("slow",function(){UCP.calibrateMenus();});}}else{if(!$("#nav-btn-presencestate").is(":visible")&&$("#presence-menu2 .options .fa").length>0){$("#nav-btn-presencestate").fadeIn("slow",function(){UCP.calibrateMenus();});$("#presencestate-menu .change-status").hide();$("#nav-btn-presencestate .icon .fa").css("color","#7b7b7b").css("opacity","1");$("#nav-btn-presencestate .p-msg").text(_("Actions List"));}}
if(!this.calibrated){UCP.calibrateMenus();this.calibrated=true;}},savePSSettings:function(){$("#message").fadeOut("slow");var data={};$(".pssettings input[type=\"text\"]").each(function(index){data[$(this).attr("name")]=$(this).val();});$(".pssettings input[type=\"checkbox\"]").each(function(index){data[$(this).attr("name")]=$(this).is(":checked");});data.events={};$(".pssettings select").each(function(index){if($(this).hasClass("event")){data.events[$(this).attr("name")]=$(this).val();}else{data[$(this).attr("name")]=$(this).val();}});$.post("?quietmode=1&module=presencestate&command=savesettings",data,function(data){if(data.status){$("#message").addClass("alert-success");$("#message").text(_("Your settings have been saved"));$("#message").fadeIn("slow",function(){setTimeout(function(){$("#message").fadeOut("slow");},2000);});Presencestate.presenceSpecials.startSessionStatus=data.startsessionstatus;Presencestate.presenceSpecials.endSessionStatus=data.endsessionstatus;}else{$("#message").addClass("alert-error");$("#message").text(data.message);return false;}});},connect:function(){$.get("index.php?quietmode=1&module=presencestate&command=statuses",{},function(data){Presencestate.menu=data;Presencestate.buildMenu(true);$("#presencestate-menu .presence-item").css("cursor","pointer");$("#presencestate-menu .statuses").css("opacity","1");});},disconnect:function(){if(UCP.loggedIn){$("#presencestate-menu .presence-item").off("click");$("#presencestate-menu .presence-item").css("cursor","not-allowed");$("#presencestate-menu .statuses").css("opacity","0.5");Presencestate.changeStatus("not_set","");}}}),Presencestate=new PresencestateC();$(document).ready(function(){$(window).bind("beforeunload",function(){if(Presencestate.presenceSpecials.endSessionStatus!==null&&navigator.onLine){$.ajax({url:"index.php?quietmode=1&module=presencestate&command=set",type:"POST",data:{state:Presencestate.presenceSpecials.endSessionStatus.id},async:false,timeout:2000});}});});var RecordingsC=UCPMC.extend({init:function(UCP){var cm=this;this.contacts={};$(document).bind("staticSettingsFinished",function(event){if(cm.staticsettings.enabled){cm.contacts=cm.staticsettings.contacts;}});},poll:function(data){var cm=this;if(data.enabled){cm.contacts=data.contacts;}},contactClickInitiateCallTo:function(did){window.location.replace("tel:"+did);},contactClickInitiateFacetime:function(did){window.location.replace("facetime:"+did);},contactClickOptions:function(type){if(type!="number"||false){return false;}
var options=[{text:_("Call To"),function:"contactClickInitiateCallTo",type:"phone"}];if(navigator.appVersion.indexOf("Mac")!=-1){options.push({text:_("Facetime"),function:"contactClickInitiateFacetime",type:"phone"});}
return options;},showActionDialog:function(type,text,p){var options="",count=0,operation=[],primary="";if(typeof type==="undefined"||typeof text==="undefined"){return;}
primary=(typeof p!=="undefined")?p:"";if(primary.indexOf(",")!=-1){var primaries=primary.split(",");}
if(type=="number"){text=text.replace(/\D/g,"");}
$.each(modules,function(index,module){if(UCP.validMethod(module,"contactClickOptions")){var o=UCP.Modules[module].contactClickOptions(type),selected="";if(o!==false&&Array.isArray(o)){$.each(o,function(k,v){if(typeof primaries!=="undefined"){if(primaries.indexOf(v.type)!=-1){if(primaries.indexOf(v.type)===0){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;}else{options=options+"<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>";}
v.module=module;operation=v;count++;}}else{if((typeof v.type!=="undefined")&&(v.type==primary)){options="<option data-function='"+v.function+"' data-module='"+module+"' "+selected+">"+v.text+"</option>"+options;v.module=module;operation=v;count++;}}});}}});if(count===0){alert(_("There are no actions for this type"));}else if(count===1){if(UCP.validMethod(operation.module,operation.function)){UCP.Modules[operation.module][operation.function](text);}}else if(count>1){UCP.showDialog(_("Select an Action"),"<select id=\"contactmanageraction\" class=\"form-control\">"+options+"</select><button class=\"btn btn-default\" id=\"initiateaction\" style=\"margin-left: 72px;\">Initiate</button>",115,250,function(){$("#initiateaction").click(function(){var func=$("#contactmanageraction option:selected").data("function"),mod=$("#contactmanageraction option:selected").data("module");if(UCP.validMethod(mod,func)){UCP.closeDialog(function(){UCP.Modules[mod][func](text);});}else{alert(_("Function call does not exist!"));}});});}},display:function(event){var $this=this;$(".clickable").click(function(e){var type=$(this).data("type"),text=$(this).text(),primary=$(this).data("primary");$this.showActionDialog(type,text,primary);});$(".recording-header th[class!=\"noclick\"]").click(function(){var icon=$(this).children("i"),visible=icon.is(":visible"),direction=icon.hasClass("fa-chevron-down")?"up":"down",type=$(this).data("type"),search=(typeof $.url().param("search")!=="undefined")?"&search="+$.url().param("search"):"",view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"",uadd=null;if(!visible){$(".cdr-header th i").addClass("hidden");icon.removeClass("hidden");}
if(direction=="up"){uadd="&order=asc&orderby="+type+search;icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");}else{uadd="&order=desc&orderby="+type+search;icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");}
$(".contact-header th[class!=\"noclick\"]").off("click");$.pjax({url:"?display=dashboard&mod=recordings"+uadd+view+id,container:"#dashboard-content"});});$("#search-text").keypress(function(e){var code=(e.keyCode?e.keyCode:e.which);if(code==13){$this.search($(this).val());e.preventDefault();}});$("#search-btn").click(function(){$this.search($("#search-text").val());});$("#delete_recording").click(function(e){e.preventDefault();var id=$("#id").val();if(confirm(_("Are you sure you want to delete this recording?"))){$("form input").prop("disabled",true);$("#delete_recording").text(_("Removing..."));$("#delete_recording").prop("disabled",true);$.post("?quietmode=1&module=recordings&command=deleterecording",{id:id},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=recordings",container:"#dashboard-content"});}});}});$("#edit_button").click(function(e){e.preventDefault();var recording={numbers:[]},$this=this;$("form input,textarea").not(".special").each(function(i,v){var item=$(v);if(item.prop("id")=='fcode')
{var FcodeValue='0';if($("#"+item.prop("id")).is(":checked"))
{FcodeValue='1';}
recording[item.prop("id")]=FcodeValue;}
else
{recording[item.prop("id")]=item.val();}});$("form input").prop("disabled",true);$(this).text(_("Updating..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=recordings&command=updaterecording",{recording:recording},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=recordings",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$("#save_button").click(function(e){if($.trim($("#rname").val())=='')
{alert('Please enter recording name');$("#rname").focus();return false;}
e.preventDefault();var recording={numbers:[]},$this=this;$("form input").not(".special").each(function(i,v){var item=$(v);recording[item.prop("id")]=item.val();});$("form input").prop("disabled",true);$(this).text(_("Adding..."));$(this).prop("disabled",true);$.post("?quietmode=1&module=recordings&command=addrecording",{recording:recording},function(data){if(data.status){$.pjax({url:"?display=dashboard&mod=recordings",container:"#dashboard-content"});}else{$($this).prop("disabled",false);}});});$(document).off("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]");if($.support.pjax){$(document).on("click","[cm-pjax] a, a[cm-pjax], [vm-pjax] a, a[vm-pjax]",function(event){var container=$("#dashboard-content");$.pjax.click(event,{container:container});});}},search:function(text){var view=(typeof $.url().param("view")!=="undefined")?"&view="+$.url().param("view"):"",id=(typeof $.url().param("id")!=="undefined")?"&id="+$.url().param("id"):"";if(text!==""){$.pjax({url:"?display=dashboard&mod=recordings&search="+encodeURIComponent(text)+view+id,container:"#dashboard-content"});}else{$.pjax({url:"?display=dashboard&mod=recordings"+view+id,container:"#dashboard-content"});}},hide:function(event){$(".clickable").off("click");$(".contact-item").off("click");$("#addgroup").off("click");$("#deletegroup").off("click");$("#deletecontact").off("click");$("#editContact input").off("blur");$("#addcontact, #updatecontact").off("click");$("#editcontact");},lookup:function(search,regExp){var o=this.recursiveObjectSearch(search,this.contacts),contact;if(o!==false){contact=this.contacts[o[0]];if(contact!==false){contact.ignore=o[0];contact.key=o[o.length-1];}
return contact;}
return false;},recursiveObjectSearch:function(search,haystack,key,strict,stack){var k,o,pattern=new RegExp(search);for(k in haystack){if(haystack.hasOwnProperty(k)&&haystack[k]!==null){if(typeof stack==="undefined"){stack=[];}
if(typeof haystack[k]==="object"){stack.push(k);o=this.recursiveObjectSearch(search,haystack[k],key,strict,stack);if(o!==false){return stack;}else{stack=[];}}else if(pattern.test(haystack[k])){stack.push(k);return stack;}}}
return false;}});var SettingsC=UCPMC.extend({init:function(){this.packery=false;this.doit=null;this.modules=[];},poll:function(data){},display:function(event){$(window).on("resize.Settings",Settings.resize);this.resize();$.each(modules,function(index,module){if(typeof window[module]=="object"&&typeof window[module].settingsDisplay=="function"){window[module].settingsDisplay();}else if(UCP.validMethod(module,"settingsDisplay")){UCP.Modules[module].settingsDisplay();}});},hide:function(event){$(window).off("resize.Settings");Settings.packery=false;$.each(modules,function(index,module){if(typeof window[module]=="object"&&typeof window[module].settingsHide=="function"){window[module].settingsDisplay();}else if(UCP.validMethod(module,"settingsHide")){UCP.Modules[module].settingsHide();}});},resize:function(){var wasPackeryEnabled=Settings.packery;Settings.packery=$(window).width()>=768;if(Settings.packery!==wasPackeryEnabled){if(Settings.packery){clearTimeout(this.doit);this.doit=setTimeout(function(){$(".section").css("width","300px");$(".section").css("margin-bottom","");$(".masonry-container").packery({columnWidth:40,itemSelector:".section"});},100);}else{Settings.packery=false;$(".masonry-container").packery("destroy");$(".section").css("width","100%");$(".section").css("margin-bottom","10px");}}else if(!Settings.packery){$(".section").css("width","100%");$(".section").css("margin-bottom","10px");}}}),Settings=new SettingsC();var SmsC=UCPMC.extend({init:function(UCP){this.packery=false;this.doit=null;this.lastchecked=Math.round(new Date().getTime()/ 1000);this.dids=[];this.icon="fa fa-comments-o";var Sms=this;$(document).bind("logIn",function(event){$("#sms-menu a.new").on("click",function(){var sfrom="";$.each(Sms.dids,function(i,v){sfrom=sfrom+"<option>"+v+"</option>";});UCP.showDialog(_("Send Message"),"<label for=\"SMSfrom\">From:</label> <select id=\"SMSfrom\" class=\"form-control\">"+sfrom+"</select><label for=\"SMSto\">To:</label><select class=\"form-control Tokenize Fill\" id=\"SMSto\" multiple></select><button class=\"btn btn-default\" id=\"initiateSMS\" style=\"margin-left: 72px;\">Initiate</button>",200,250,function(){$("#SMSto").tokenize({maxElements:1,datas:"index.php?quietmode=1&module=sms&command=contacts"});$("#initiateSMS").click(function(){setTimeout(function(){Sms.initiateChat();},50);});$("#SMSto").keypress(function(event){if(event.keyCode==13){setTimeout(function(){Sms.initiateChat();},50);}});});});$("#sms-menu a.did").on("click",function(){var tdid=$(this).data("did"),sfrom="",name=tdid,selected="",temp="";if(UCP.validMethod("Contactmanager","lookup")){if(typeof UCP.Modules.Contactmanager.lookup(tdid).displayname!=="undefined"){name=UCP.Modules.Contactmanager.lookup(tdid).displayname;}else{temp=String(tdid).length==11?String(tdid).substring(1):tdid;if(typeof UCP.Modules.Contactmanager.lookup(temp).displayname!=="undefined"){name=UCP.Modules.Contactmanager.lookup(temp).displayname;}}}
selected="<option value=\""+tdid+"\" selected>"+name+"</option>";$.each(Sms.dids,function(i,v){sfrom=sfrom+"<option>"+v+"</option>";});UCP.showDialog(_("Send Message"),"<label for=\"SMSfrom\">From:</label> <select id=\"SMSfrom\" class=\"form-control\">"+sfrom+"</select><label for=\"SMSto\">To:</label><select class=\"form-control Tokenize Fill\" id=\"SMSto\" multiple>"+selected+"</select><button class=\"btn btn-default\" id=\"initiateSMS\" style=\"margin-left: 72px;\">Initiate</button>",200,250,function(){$("#SMSto").tokenize({maxElements:1,datas:"index.php?quietmode=1&module=sms&command=contacts"});$("#initiateSMS").click(function(){setTimeout(function(){Sms.initiateChat();},50);});$("#SMSto").keypress(function(event){if(event.keyCode==13){setTimeout(function(){Sms.initiateChat();},50);}});});});});$(document).on("chatWindowAdded",function(event,windowId,module,object){if(module=="Sms"){object.on("click",function(){object.find(".title-bar").css("background-color","");});var from=$(".message-box[data-id=\""+windowId+"\"]").data("from"),to=$(".message-box[data-id=\""+windowId+"\"]").data("to");object.find("textarea").keyup(function(event){if(event.keyCode==13){var message=$(this).val();Sms.sendMessage(windowId,from,to,message);}});object.find(".chat").scroll(function(){if($(this)[0].scrollTop===0){var id=$(".chat .message:lt(1)").data("id");$(".message-box[data-id=\""+windowId+"\"] .chat .history").prepend('<div class="message status">Loading...</div>');$.post("index.php?quietmode=1&module=sms&command=history",{id:id,from:from,to:to},function(data){$(".message-box[data-id=\""+windowId+"\"] .chat .history .status").remove();var html="";$.each(data.messages,function(i,v){html=html+"<div class=\"message\" data-id=\""+v.id+"\"><strong>"+v.from+":</strong>"+v.message+"</div>";});$(".message-box[data-id=\""+windowId+"\"] .chat .history").prepend(html);});}});}});$(document).bind("staticSettingsFinished",function(event){if((typeof Sms.staticsettings!=="undefined")&&Sms.staticsettings.enabled){Sms.dids=Sms.staticsettings.dids;}});},contactClickInitiate:function(did){var tdid=did,Sms=this,sfrom="",name=tdid,selected="",temp="";if(UCP.validMethod("Contactmanager","lookup")){if(typeof UCP.Modules.Contactmanager.lookup(tdid).displayname!=="undefined"){name=UCP.Modules.Contactmanager.lookup(tdid).displayname;}else{temp=String(tdid).length==11?String(tdid).substring(1):tdid;if(typeof UCP.Modules.Contactmanager.lookup(temp).displayname!=="undefined"){name=UCP.Modules.Contactmanager.lookup(temp).displayname;}}}
selected="<option value=\""+tdid+"\" selected>"+name+"</option>";$.each(Sms.dids,function(i,v){sfrom=sfrom+"<option>"+v+"</option>";});UCP.showDialog(_("Send Message"),"<label for=\"SMSfrom\">From:</label> <select id=\"SMSfrom\" class=\"form-control\">"+sfrom+"</select><label for=\"SMSto\">To:</label><select class=\"form-control Tokenize Fill\" id=\"SMSto\" multiple>"+selected+"</select><button class=\"btn btn-default\" id=\"initiateSMS\" style=\"margin-left: 72px;\">Initiate</button>",200,250,function(){$("#SMSto").tokenize({maxElements:1,datas:"index.php?quietmode=1&module=sms&command=contacts"});$("#initiateSMS").click(function(){setTimeout(function(){Sms.initiateChat();},50);});$("#SMSto").keypress(function(event){if(event.keyCode==13){setTimeout(function(){Sms.initiateChat();},50);}});});},contactClickOptions:function(type){if(type!="number"){return false;}
return[{text:_("Send SMS"),function:"contactClickInitiate",type:"sms"}];},replaceContact:function(contact){var entry=null;if(UCP.validMethod("Contactmanager","lookup")){scontact=contact.length==11?contact.substring(1):contact;entry=UCP.Modules.Contactmanager.lookup(scontact);if(entry!==null&&entry!==false){return entry.displayname;}
entry=UCP.Modules.Contactmanager.lookup(contact);if(entry!==null&&entry!==false){return entry.displayname;}}
return contact;},prepoll:function(data){var Sms=this,messageBoxes={messageWindows:{},lastchecked:this.lastchecked};$(".message-box[data-module=\"Sms\"]").each(function(i,v){var windowid=$(this).data("id"),from=$(this).data("from"),to=$(this).data("to"),last=$(this).data("last-msg-id");messageBoxes.messageWindows[i]={from:from,to:to,last:last,windowid:windowid};});this.lastchecked=Math.round(new Date().getTime()/ 1000);return messageBoxes;},poll:function(data){var Sms=this,delivered=[];if(data.status){$.each(data.messages,function(windowid,messages){$.each(messages,function(index,v){if(!$(".message-box[data-id=\""+windowid+"\"] .message[data-id=\""+v.id+"\"]").length){var Notification=new Notify(sprintf(_("New Message from %s"),Sms.replaceContact(v.from)),{body:emojione.unifyUnicode(v.body),icon:"modules/Sms/assets/images/comment.png",timeout:3});UCP.addChat("Sms",windowid,Sms.icon,v.did,v.recp,Sms.replaceContact(v.cnam),v.id,v.body);delivered.push(v.id);if(UCP.notify){Notification.show();}}});});if(delivered.length){$.post("index.php?quietmode=1&module=sms&command=delivered",{ids:delivered},function(data){});}}},display:function(event){var Sms=this;$(document).on("click","[vm-pjax] a, a[vm-pjax]",function(event){event.preventDefault();var container=$("#dashboard-content");$.pjax.click(event,{container:container});});$(".message-header th[class!=\"noclick\"]").click(function(){var icon=$(this).children("i"),visible=icon.is(":visible"),direction=icon.hasClass("fa-chevron-down")?"up":"down",type=$(this).data("type"),uadd=null,search=(typeof $.url().param("search")!=="undefined")?"&search="+$.url().param("search"):"";if(!visible){$(".cdr-header th i").addClass("hidden");icon.removeClass("hidden");}
if(direction=="up"){uadd="&order=asc&orderby="+type+search;icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");}else{uadd="&order=desc&orderby="+type+search;icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");}
$(".cdr-header th[class!=\"noclick\"]").off("click");$.pjax({url:"?display=dashboard&mod=sms"+uadd,container:"#dashboard-content"});});$("i.fa-eye").click(function(){var id=$(this).data("id");$("#"+id+"-messages").toggle();$("#"+id+"-messages").find(".sms-message-body").each(function(){$(this).scrollTop(0);});});$("i.fa-trash-o").click(function(){if(confirm(_("Are you Sure you wish to delete this chat history?"))){var thread=$(this).parents(".sms-message");$.post("index.php?quietmode=1&module=sms&command=delete",{from:thread.data("from"),to:thread.data("to")},function(data){if(data.status){thread.fadeOut("slow");}else{}});}});$("#search-text").keypress(function(e){var code=null;code=(e.keyCode?e.keyCode:e.which);if(code==13){Sms.search($(this).val());e.preventDefault();}});$("#search-btn").click(function(){Sms.search($("#search-text").val());});if(typeof $.url().param("search")!=="undefined"){$(".sms-message-body").highlight($.url().param("search"),"yellow");}},search:function(text){var Sms=this;if(text!==""){$.pjax({url:"?display=dashboard&mod=sms&search="+encodeURIComponent(text),container:"#dashboard-content"});}else{$.pjax({url:"?display=dashboard&mod=sms",container:"#dashboard-content"});}},hide:function(event){var Sms=this;$(document).off("click","[vm-pjax] a, a[vm-pjax]");},resize:function(){},initiateChat:function(){var Sms=this,to=($("#SMSto").val()!==null)?$("#SMSto").val()[0]:"",from=$("#SMSfrom").val(),pattern=new RegExp(/^\d*$/);if(to!==""&&to.length<=11&&to.length>=10&&pattern.test(to)){to=(to.length===10)?"1"+to:to;UCP.addChat("Sms",from+to,Sms.icon,from,to);UCP.closeDialog();}else{alert(_("Invalid Number"));}},startChat:function(from,to){var Sms=this;UCP.addChat("Sms",from+to,Sms.icon,from,to);},sendMessage:function(windowId,from,to,message){var Sms=this;$(".message-box[data-id='"+windowId+"'] textarea").prop("disabled",true);$.post("index.php?quietmode=1&module=sms&command=send",{from:from,to:to,message:message},function(data){if(data.status){UCP.addChatMessage(windowId,from,data.id,message,false);$(".message-box[data-id='"+windowId+"'] textarea").val("");}else{}
$(".message-box[data-id='"+windowId+"'] textarea").prop("disabled",false);$(".message-box[data-id='"+windowId+"'] textarea").focus();});}});var VoicemailC=UCPMC.extend({init:function(){this.loaded=null;this.recording=false;this.recorder=null;this.recordTimer=null;this.startTime=null;this.soundBlobs={};this.placeholders=[];},getInfo:function(){return{name:_("Voicemail")};},settingsDisplay:function(){var $this=this;$("#ddial, #vmx-p1_enable").change(function(){$this.findmeFollowState();});this.findmeFollowState();$("#module-Voicemail form .input-group").each(function(index){$(this).find("input[type=\"text\"]").prop("disabled",!$(this).find("input[type=\"checkbox\"]").is(":checked"));});$("#module-Voicemail input[type=\"text\"]").change(function(){$(this).blur(function(){$this.saveVmXSettings($(this).prop("name"),$(this).val());$(this).off("blur");});});$("#module-Voicemail .input-group input[type=\"checkbox\"]").change(function(){var el=$(this).data("el");if(!$(this).is(":checked")){$("#"+el).prop("disabled",true);$("#"+el).prop("placeholder",$("#"+el).data("ph"));if($("#"+el).val()!==""){$("#"+el).val("");$this.saveVmXSettings($("#"+el).prop("name"),"");}}else{$("#"+el).prop("placeholder","");$("#"+el).prop("disabled",false);}});$("#module-Voicemail .dests input[type=\"checkbox\"]").change(function(){$this.saveVmXSettings($(this).prop("name"),$(this).is(":checked"));});},settingsHide:function(){$("#module-Voicemail input[type=\"text\"], #module-Findmefollow textarea").off("change");$("#module-Voicemail input[type=\"checkbox\"]").off("change");$("#ddial, #vmx-p1_enable").off("change");},findmeFollowState:function(){if(!$("#vmx-p1_enable").is(":checked")&&!$("#ddial").is(":checked")){$("#vmxerror").text(_("Find me Follow me is disabled when VmX locator option 1 is disabled as well!")).addClass("alert-danger").fadeIn("fast");}else{$("#vmxerror").fadeOut("fast");}},saveVmXSettings:function(key,value){var data={ext:ext,settings:{key:key,value:value}};$.post("index.php?quietmode=1&module=voicemail&command=vmxsettings",data,function(data){if(data.status){$("#vmxmessage").text(data.message).addClass("alert-"+data.alert).fadeIn("fast",function(){$(this).delay(5000).fadeOut("fast",function(){$(".masonry-container").packery();});});$(".masonry-container").packery();}else{return false;}});},poll:function(data){if(data.status){var notify=0,voicemailNotification={};if($("#voicemail-badge").html()<data.total){notify=data.total-$("#voicemail-badge").html();}
$("#voicemail-badge").html(data.total);$.each(data.boxes,function(extension,messages){if($("#voicemail-"+extension+"-badge").html()<messages){notify=(messages-$("#voicemail-badge").html())+notify;}
$("#voicemail-"+extension+"-badge").html(messages);});voicemailNotification=new Notify("Voicemail",{body:sprintf(_("You Have %s New Voicemail"),notify),icon:"modules/Voicemail/assets/images/mail.png"});if(notify>0){if(UCP.notify){voicemailNotification.show();}
$(".mailbox .folder-list .folder.active a").click();}}},display:function(event){var $this=this;$this.init();if(!Modernizr.getusermedia){$(".jp-record-wrapper").hide();$(".record-greeting-btn").hide();}else{$(".jp-record-wrapper").show();$(".jp-stop-wrapper").hide();$(".record-greeting-btn").show();}
$(".clickable").click(function(e){var text=$(this).text();if(UCP.validMethod("Contactmanager","showActionDialog")){UCP.Modules.Contactmanager.showActionDialog("number",text,"phone");}});$(".vm-message a.listen").click(function(){var id=$(this).data("id"),select=null;$.each(mailboxes,function(i,v){select=select+"<option value='"+v+"'>"+v+"</option>";});UCP.showDialog(_("Listen to Voicemail"),_("On")+":</label><select class=\"form-control\" id=\"VMto\">"+select+"</select><button class=\"btn btn-default\" id=\"listenVM\" style=\"margin-left: 72px;\">"+_("Listen")+"</button>",145,250,function(){$("#listenVM").click(function(){var recpt=$("#VMto").val();$this.listenVoicemail(id,recpt);});$("#VMto").keypress(function(event){if(event.keyCode==13){var recpt=$("#VMto").val();$this.listenVoicemail(id,recpt);}});});});$(".vm-message a.forward").click(function(){var id=$(this).data("id");UCP.showDialog(_("Forward Voicemail"),_("To")+":</label><select class=\"form-control Fill\" id=\"VMto\"></select><button class=\"btn btn-default\" id=\"forwardVM\" style=\"margin-left: 72px;\">"+_("Forward")+"</button>",145,250,function(){$("#VMto").tokenize({newElements:false,maxElements:1,datas:"index.php?quietmode=1&module=voicemail&command=forwards&ext="+extension});$("#forwardVM").click(function(){setTimeout(function(){var recpt=$("#VMto").val()[0];$this.forwardVoicemail(id,recpt);},50);});$("#VMto").keypress(function(event){if(event.keyCode==13){setTimeout(function(){var recpt=$("#VMto").val()[0];$this.forwardVoicemail(id,recpt);},50);}});});});$(".vm-message a.play").click(function(){var id=$(this).data("id");$this.playVoicemail(id);});$(".vm-message a.delete").click(function(){var id=$(this).data("id");$this.deleteVoicemail(id);});$(".recording-controls .save").click(function(){var id=$(this).data("id");$this.saveRecording(id);});$(".recording-controls .delete").click(function(){var id=$(this).data("id");$this.deleteRecording(id);});$(".file-controls .record, .jp-record").click(function(){var id=$(this).data("id");$this.recordGreeting(id);});$(".file-controls .delete").click(function(){var id=$(this).data("id");$this.deleteGreeting(id);});if(Modernizr.draganddrop){$this.enableDrags();$(".mailbox .folder-list .folder").on("drop",function(event){if(event.stopPropagation){event.stopPropagation();}
if(event.preventDefault){event.preventDefault();}
var msg=event.originalEvent.dataTransfer.getData("msg"),folder=$(event.currentTarget).data("folder"),data={msg:msg,folder:folder,ext:extension};$.post("index.php?quietmode=1&module=voicemail&command=moveToFolder",data,function(data){if(data.status){$(this).removeClass("hover");var dragSrc=$(".message-list .vm-message[data-msg=\""+msg+"\"]"),badge=null;dragSrc.remove();$(".vm-temp").remove();badge=$(event.currentTarget).find(".badge");badge.text(Number(badge.text())+1);badge=$(".mailbox .folder-list .folder.active").find(".badge");badge.text(Number(badge.text())-1);$("#freepbx_player_"+msg).jPlayer("pause");$("#vm_playback_"+msg).remove();}else{}});});$(".mailbox .folder-list .folder").on("dragover",function(event){if(event.preventDefault){event.preventDefault();}
$(this).addClass("hover");});$(".mailbox .folder-list .folder").on("dragenter",function(event){$(this).addClass("hover");});$(".mailbox .folder-list .folder").on("dragleave",function(event){$(this).removeClass("hover");});$(".greeting-control .jp-audio").on("dragstart",function(event){event.originalEvent.dataTransfer.effectAllowed="move";event.originalEvent.dataTransfer.setData("type",$(this).data("type"));$(this).fadeTo("fast",0.5);});$(".greeting-control .jp-audio").on("dragend",function(event){$(this).fadeTo("fast",1.0);});$(".filedrop").on("drop",function(event){if(event.originalEvent.dataTransfer.files.length===0){if(event.stopPropagation){event.stopPropagation();}
if(event.preventDefault){event.preventDefault();}
$(this).removeClass("hover");var target=$(this).data("type"),source=event.originalEvent.dataTransfer.getData("type");if(source===""){alert(_("Not a valid Draggable Object"));return false;}
if(source==target){alert(_("Dragging to yourself is not allowed"));return false;}
var data={ext:extension,source:source,target:target},message=$(this).find(".message");message.text(_("Copying..."));$.post("index.php?quietmode=1&module=voicemail&command=copy",data,function(data){if(data.status){$("#freepbx_player_"+target).jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid="+target+"&format=wav&ext="+extension,oga:"?quietmode=1&module=voicemail&command=listen&msgid="+target+"&format=oga&ext="+extension});message.text(_("Drag a New Greeting Here"));$this.toggleGreeting(target,true);}else{return false;}});}});$(".filedrop").on("dragover",function(event){if(event.preventDefault){event.preventDefault();}
$(this).addClass("hover");});$(".filedrop").on("dragleave",function(event){$(this).removeClass("hover");});}else{alert(_("You have No Drag/Drop Support!"));}
$(document).off("click","[vm-pjax] a, a[vm-pjax]");if($.support.pjax){$(document).on("click","[vm-pjax] a, a[vm-pjax]",function(event){var container=$("#dashboard-content");$.pjax.click(event,{container:container});$this.enableDrags();});}
$("#freepbx_player_unavail").jPlayer({ready:function(event){$(this).jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid=unavail&format=wav&ext="+extension,oga:"?quietmode=1&module=voicemail&command=listen&msgid=unavail&format=oga&ext="+extension});},swfPath:"assets/js",supplied:supportedMediaFormats,warningAlerts:false,cssSelectorAncestor:"#freepbx_player_unavail_1"});$("#unavail input[type=\"file\"]").fileupload({url:"?quietmode=1&module=voicemail&command=upload&type=unavail&ext="+extension,dropZone:$("#unavail .filedrop"),dataType:"json",add:function(e,data){$("#unavail .filedrop .message").text(_("Uploading..."));data.submit();},done:function(e,data){if(data.result.status){$("#unavail .filedrop .pbar").css("width","0%");$("#unavail .filedrop .message").text(_("Drag a New Greeting Here"));$("#freepbx_player_unavail").jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid=unavail&format=wav&ext="+extension+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid=unavail&format=oga&ext="+extension+"&rand="+$this.generateRandom()});$this.toggleGreeting("unavail",true);}else{console.log(data.result.message);}},progressall:function(e,data){var progress=parseInt(data.loaded / data.total*100,10);$("#unavail .filedrop .pbar").css("width",progress+"%");},drop:function(e,data){$("#unavail .filedrop").removeClass("hover");}});$("#freepbx_player_busy").jPlayer({ready:function(event){$(this).jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid=busy&format=wav&ext="+extension+"&rand="+$this.generateRandom()+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid=busy&format=oga&ext="+extension+"&rand="+$this.generateRandom()+"&rand="+$this.generateRandom()});},swfPath:"assets/js",supplied:supportedMediaFormats,warningAlerts:false,cssSelectorAncestor:"#freepbx_player_busy_1"});$("#busy input[type=\"file\"]").fileupload({url:"?quietmode=1&module=voicemail&command=upload&type=busy&ext="+extension,dropZone:$("#busy .filedrop"),dataType:"json",add:function(e,data){$("#busy .filedrop .message").text(_("Uploading..."));data.submit();},done:function(e,data){if(data.result.status){$("#busy .filedrop .pbar").css("width","0%");$("#busy .filedrop .message").text(_("Drag a New Greeting Here"));$("#freepbx_player_busy").jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid=busy&format=wav&ext="+extension+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid=busy&format=oga&ext="+extension+"&rand="+$this.generateRandom()});$this.toggleGreeting("busy",true);}else{console.log(data.result.message);}},progressall:function(e,data){var progress=parseInt(data.loaded / data.total*100,10);$("#busy .filedrop .pbar").css("width",progress+"%");},drop:function(e,data){$("#busy .filedrop").removeClass("hover");}});$("#freepbx_player_greet").jPlayer({ready:function(event){$(this).jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid=greet&format=wav&ext="+extension+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid=greet&format=oga&ext="+extension+"&rand="+$this.generateRandom()});},swfPath:"assets/js",supplied:supportedMediaFormats,warningAlerts:false,cssSelectorAncestor:"#freepbx_player_greet_1"});$("#greet input[type=\"file\"]").fileupload({url:"?quietmode=1&module=voicemail&command=upload&type=greet&ext="+extension,dropZone:$("#greet .filedrop"),dataType:"json",add:function(e,data){$("#greet .filedrop .message").text(_("Uploading..."));data.submit();},done:function(e,data){if(data.result.status){$("#greet .filedrop .pbar").css("width","0%");$("#greet .filedrop .message").text(_("Drag a New Greeting Here"));$("#freepbx_player_greet").jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid=greet&format=wav&ext="+extension+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid=greet&format=oga&ext="+extension+"&rand="+$this.generateRandom()});$this.toggleGreeting("greet",true);}else{console.log(data.result.message);}},progressall:function(e,data){var progress=parseInt(data.loaded / data.total*100,10);$("#greet .filedrop .pbar").css("width",progress+"%");},drop:function(e,data){$.each(data.files,function(index,file){});$("#greet .filedrop").removeClass("hover");$("#greet .filedrop .message").text(_("Uploading..."));}});$("#freepbx_player_temp").jPlayer({ready:function(event){$(this).jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid=temp&format=wav&ext="+extension+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid=temp&format=oga&ext="+extension+"&rand="+$this.generateRandom()});},swfPath:"assets/js",supplied:supportedMediaFormats,warningAlerts:false,cssSelectorAncestor:"#freepbx_player_temp_1"});$("#temp input[type=\"file\"]").fileupload({url:"?quietmode=1&module=voicemail&command=upload&type=temp&ext="+extension,dropZone:$("#temp .filedrop"),dataType:"json",add:function(e,data){$("#temp .filedrop .message").text(_("Uploading..."));data.submit();},done:function(e,data){if(data.result.status){$("#temp .filedrop .pbar").css("width","0%");$("#temp .filedrop .message").text(_("Drag a New Greeting Here"));$("#freepbx_player_temp").jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid=temp&format=wav&ext="+extension+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid=temp&format=oga&ext="+extension+"&rand="+$this.generateRandom()});$this.toggleGreeting("temp",true);}else{console.log(data.result.message);}},progressall:function(e,data){var progress=parseInt(data.loaded / data.total*100,10);$("#temp .filedrop .pbar").css("width",progress+"%");},drop:function(e,data){$("#temp .filedrop").removeClass("hover");}});$(".vmsettings input[type!=\"checkbox\"]").change(function(){$(this).blur(function(){$this.saveVMSettings();$(this).off("blur");});});$(".vmsettings input[type=\"checkbox\"]").change(function(){$this.saveVMSettings();});},hide:function(event){$(".vm-message a.play").off("click");$(".vm-message a.delete").off("click");},CheckNoMessages:function(){if(!$(".vm-message").length){}},deleteGreeting:function(type){var $this=this,data={msg:type,ext:extension};$.post("index.php?quietmode=1&module=voicemail&command=delete",data,function(data){if(data.status){$this.toggleGreeting(type,false);$("#freepbx_player_"+type).jPlayer("clearMedia");}else{return false;}});},playVoicemail:function(msgid){var player=$("#freepbx_player_"+msgid),cid=$(".vm-message[data-msg=\""+msgid+"\"] .cid").text(),container=$("#vm_playback_"+msgid),icon=$(".vm-message[data-msg=\""+msgid+"\"] .play i");player.jPlayer({ready:function(event){},swfPath:"assets/js",supplied:supportedMediaFormats,warningAlerts:false,cssSelectorAncestor:"#freepbx_container_"+msgid}).bind($.jPlayer.event.loadstart,function(event){$("#freepbx_container_"+msgid+" .jp-message-window").show();$("#freepbx_container_"+msgid+" .jp-message-window .message").css("color","");$("#freepbx_container_"+msgid+" .jp-seek-bar").css("background",'url("modules/Cdr/assets/images/jplayer.blue.monday.seeking.gif") 0 0 repeat-x');});player.bind($.jPlayer.event.play,function(event){icon.removeClass("fa-play").addClass("fa-pause");});player.bind($.jPlayer.event.pause,function(event){icon.removeClass("fa-pause").addClass("fa-play");});player.bind($.jPlayer.event.canplay,function(event){$(".jp-message-window").fadeOut("fast");$("#freepbx_container_"+msgid+" .jp-seek-bar").css("background","");});player.bind($.jPlayer.event.error,function(event){$("#freepbx_container_"+msgid+" .jp-message-window").show();$("#freepbx_container_"+msgid+" .message").text(event.jPlayer.error.message).css("color","red");$("#freepbx_container_"+msgid+" .jp-seek-bar").css("background","");});if(this.loaded!==null&&this.loaded!=msgid){$("#freepbx_player_"+this.loaded).jPlayer("pause");$("#vm_playback_"+this.loaded).slideUp("fast");}
this.loaded=msgid;if(player.data().jPlayer.status.waitForLoad){player.jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid="+msgid+"&format=wav&ext="+extension,oga:"?quietmode=1&module=voicemail&command=listen&msgid="+msgid+"&format=oga&ext="+extension});if(container.is(":hidden")){$("#freepbx_container_"+msgid+" .title-text").text(cid);container.slideDown(function(event){player.jPlayer("play");icon.removeClass("fa-play").addClass("fa-pause");});}else{player.jPlayer("play",0);icon.removeClass("fa-play").addClass("fa-pause");$("#freepbx_container_"+msgid+" .title-text").text(cid);}}else{if(player.data().jPlayer.status.paused){if(container.is(":hidden")){$("#freepbx_container_"+msgid+" .title-text").text(cid);container.slideDown(function(event){player.jPlayer("play",0);icon.removeClass("fa-play").addClass("fa-pause");});}else{player.jPlayer("play");}}else{player.jPlayer("pause");}}},listenVoicemail:function(msgid,recpt){var data={id:msgid,to:recpt};$.post("index.php?quietmode=1&module=voicemail&command=callme&ext="+extension,data,function(data){UCP.closeDialog();});},forwardVoicemail:function(msgid,recpt){var data={id:msgid,to:recpt};$.post("index.php?quietmode=1&module=voicemail&command=forward&ext="+extension,data,function(data){UCP.closeDialog();});},deleteVoicemail:function(msgid){var $this=this,player=$("#freepbx_player"),data={msg:msgid,ext:extension};if(confirm(_("Are you sure you wish to delete this voicemail?"))){$.post("index.php?quietmode=1&module=voicemail&command=delete",data,function(data){if(data.status){$(".vm-message[data-msg=\""+msgid+"\"]").fadeOut("fast",function(){$this.CheckNoMessages();});$("#vm_playback_"+msgid).fadeOut("fast");var num=$(".mailbox .folder-list .folder.active .badge").text();$(".mailbox .folder-list .folder.active .badge").text(num-1);num=$("#voicemail-badge").text();$("#voicemail-badge").text(num-1);}else{return false;}});}},toggleGreeting:function(type,visible){if(visible===true){$("#"+type+" button").fadeIn();$("#freepbx_player_"+type+"_1").slideDown();}else{$("#"+type+" button").fadeOut();$("#freepbx_player_"+type+"_1").slideUp();}},saveVMSettings:function(){$("#message").fadeOut("slow");var data={ext:extension};$(".vmsettings input[type!=\"checkbox\"]").each(function(index){data[$(this).attr("name")]=$(this).val();});$(".vmsettings input[type=\"checkbox\"]").each(function(index){data[$(this).attr("name")]=$(this).is(":checked");});$.post("?quietmode=1&module=voicemail&command=savesettings",data,function(data){if(data.status){$("#message").addClass("alert-success");$("#message").text(_("Your settings have been saved"));$("#message").fadeIn("slow",function(){setTimeout(function(){$("#message").fadeOut("slow");},2000);});}else{$("#message").addClass("alert-error");$("#message").text(data.message);return false;}});},enableDrags:function(){$(".mailbox .vm-message").on("drop",function(event){});$(".mailbox .vm-message").on("dragstart",function(event){$(this).fadeTo("fast",0.5);event.originalEvent.dataTransfer.effectAllowed="move";event.originalEvent.dataTransfer.setData("msg",$(this).data("msg"));});$(".mailbox .vm-message").on("dragend",function(event){$(".vm-temp").remove();$(this).fadeTo("fast",1.0);});$(".mailbox .vm-message").on("dragenter",function(event){});},recordGreeting:function(type){var $this=this;if(!Modernizr.getusermedia){alert(_("Direct Media Recording is Unsupported in your Broswer!"));return false;}
counter=$("#"+type+" .jp-current-time");title=$("#"+type+" .title-text");filec=$("#"+type+" .file-controls");recc=$("#"+type+" .recording-controls");if($this.recording){clearInterval($this.recordTimer);title.text(_("Recorded Message"));$this.recorder.stop();$this.recorder.exportWAV(function(blob){$this.soundBlobs[type]=blob;var url=(window.URL||window.webkitURL).createObjectURL(blob);$("#freepbx_player_"+type).jPlayer("clearMedia");$("#freepbx_player_"+type).jPlayer("setMedia",{wav:url});});$this.recording=false;}else{window.AudioContext=window.AudioContext||window.webkitAudioContext;var context=new AudioContext();var gUM=Modernizr.prefixed("getUserMedia",navigator);gUM({audio:true},function(stream){var mediaStreamSource=context.createMediaStreamSource(stream);$this.recorder=new Recorder(mediaStreamSource,{workerPath:"assets/js/recorderWorker.js"});$this.recorder.record();$this.startTime=new Date();$this.recordTimer=setInterval(function(){var mil=(new Date()-$this.startTime);var temp=(mil / 1000);var min=("0"+Math.floor((temp%=3600)/ 60)).slice(-2);var sec=("0"+Math.round(temp%60)).slice(-2);counter.text(min+":"+sec);},1000);title.text(_("Recording..."));$this.recording=true;filec.hide();recc.show();$("#"+type+" .jp-audio").slideDown();},function(e){alert(_("Your Browser Blocked The Recording, Please check your settings"));$this.recording=false;});}},saveRecording:function(type){var $this=this;title=$("#"+type+" .title-text");if($this.recording){alert(_("Stop the Recording First before trying to save"));return false;}
if((typeof($this.soundBlobs[type])!=="undefined")&&$this.soundBlobs[type]!==null){$("#"+type+" .filedrop .message").text(_("Uploading..."));var data=new FormData();data.append("file",$this.soundBlobs[type]);$.ajax({type:"POST",url:"index.php?quietmode=1&module=voicemail&command=record&type="+type+"&ext="+extension,xhr:function()
{var xhr=new window.XMLHttpRequest();xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){var percentComplete=evt.loaded / evt.total,progress=Math.round(percentComplete*100);$("#"+type+" .filedrop .pbar").css("width",progress+"%");}},false);return xhr;},data:data,processData:false,contentType:false,success:function(data){$("#"+type+" .filedrop .message").text("Drag a New Greeting Here");$("#"+type+" .filedrop .pbar").css("width","0%");$this.soundBlobs[type]=null;filec.show();recc.hide();$("#freepbx_player_"+type).jPlayer("clearMedia");$("#freepbx_player_"+type).jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid="+type+"&format=wav&ext="+extension+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid="+type+"&format=oga&ext="+extension+"&rand="+$this.generateRandom()});title.text(title.data("title"));},error:function(){}});}},deleteRecording:function(type){var $this=this;if($this.recording){alert(_("Stop the Recording First before trying to delete"));return false;}
if((typeof($this.soundBlobs[type])!=="undefined")&&$this.soundBlobs[type]!==null){$this.soundBlobs[type]=null;filec.show();recc.hide();$("#freepbx_player_"+type).jPlayer("clearMedia");$("#freepbx_player_"+type).jPlayer("setMedia",{wav:"?quietmode=1&module=voicemail&command=listen&msgid="+type+"&format=wav&ext="+extension+"&rand="+$this.generateRandom(),oga:"?quietmode=1&module=voicemail&command=listen&msgid="+type+"&format=oga&ext="+extension+"&rand="+$this.generateRandom()});title.text(title.data("title"));}else{alert(_("There is nothing to delete"));}},generateRandom:function(){return Math.round(new Date().getTime()/ 1000);}});var WebrtcC=UCPMC.extend({init:function(){this.windowId=null;this.phone=null;this.activeCalls={};this.activeCallId=null;this.answering=false;this.stick=false;this.disconnected=false;this.userBlocked=false;this.callBinds=["progress","ended","failed","newDTMF","hold","unhold","connecting","accepted","confirmed","addstream"];this.callOptions={"mediaConstraints":{"audio":true,"video":false}};this.notification=null;},settingsDisplay:function(){},settingsHide:function(){},contactClickOptions:function(type){if(type!="number"||!this.staticsettings.enableOriginate){return false;}
return[{text:_("Originate Call"),function:"contactClickInitiate",type:"phone"}];},contactClickInitiate:function(did){var Webrtc=this,sfrom="",temp="",name=did,selected="";if(UCP.validMethod("Contactmanager","lookup")){if(typeof UCP.Modules.Contactmanager.lookup(did).displayname!=="undefined"){name=UCP.Modules.Contactmanager.lookup(did).displayname;}else{temp=String(did).length==11?String(did).substring(1):did;if(typeof UCP.Modules.Contactmanager.lookup(temp).displayname!=="undefined"){name=UCP.Modules.Contactmanager.lookup(temp).displayname;}}}
$.each(Webrtc.staticsettings.extensions,function(i,v){sfrom=sfrom+"<option>"+v+"</option>";});selected="<option value=\""+did+"\" selected>"+name+"</option>";UCP.showDialog(_("Originate Call"),"<label for=\"originateFrom\">From:</label> <select id=\"originateFrom\" class=\"form-control\">"+sfrom+"</select><label for=\"originateTo\">To:</label><select class=\"form-control Tokenize Fill\" id=\"originateTo\" multiple>"+selected+"</select><button class=\"btn btn-default\" id=\"originateCall\" style=\"margin-left: 72px;\">"+_("Originate")+"</button>",200,250,function(){$("#originateTo").tokenize({maxElements:1,datas:"index.php?quietmode=1&module=webrtc&command=contacts"});$("#originateCall").click(function(){setTimeout(function(){UCP.Modules.Webrtc.originate();},50);});$("#originateTo").keypress(function(event){if(event.keyCode==13){setTimeout(function(){UCP.Modules.Webrtc.originate();},50);}});});},engineEvent:function(type,event){console.log("Engine "+type);switch(type){case"newRTCSession":this.manageSession(event);break;case"connecting":$("#nav-btn-webrtc .fa-phone").css("color","yellow");break;case"connected":$("#nav-btn-webrtc .fa-phone").css("color","green");break;case"unregistered":case"registrationFailed":$("#nav-btn-webrtc .fa-phone").css("color","red");break;}},setPhone:function(stick,s,m){if(typeof stick!=="undefined"&&stick){this.stick=true;}
var Webrtc=this,message=(typeof m!=="undefined")?m:"",state=(typeof s!=="undefined")?s:"call";if(this.windowId===null){this.windowId=Math.floor((Math.random()*1000)+1);}
if($("#messages-container .phone-box[data-id=\""+this.windowId+"\"]").length===0){UCP.addPhone("Webrtc",this.windowId,state,message,this.contactOptions,function(id,state,message){$("#messages-container .phone-box[data-id=\""+Webrtc.windowId+"\"] .contactDisplay .contactInfo span").text(message);$("#messages-container .phone-box[data-id=\""+Webrtc.windowId+"\"] .contactDisplay .contactInfo").textfill();Webrtc.switchState(state);});}else{$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .message").text(message);$("#messages-container .phone-box .message-container").textfill();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .contactDisplay .contactInfo span").text(message);$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .contactDisplay .contactInfo").textfill();Webrtc.switchState(state);}},playRing:function(){$("#ringtone").trigger("play");},stopRing:function(){$("#ringtone").trigger("pause");$("#ringtone").trigger("load");},manageSession:function(e){var Webrtc=this,id,cnam,cnum,displayName,status,request=e.request,call=e.session,uri=call.remote_identity.uri;id=Math.floor((Math.random()*100000)+1);if(this.activeCallId){call.terminate();return false;}
if(!this.activeCallId){this.activeCallId=id;this.activeCalls[id]=call;}
cnam=this.activeCalls[id].remote_identity.display_name||"";cnum=this.activeCalls[id].remote_identity.uri.user;displayName=(cnam!=="")?cnam+" <"+cnum+">":cnum;if(this.activeCalls[id].direction==="incoming"){this.setPhone(false,"answer","From: "+displayName);if(UCP.notify){this.notification=new Notify("Incoming call from "+displayName,{body:"Click this window to answer or close this window to ignore",icon:"modules/Faxpro/assets/images/fax.png",notifyClose:function(){if(Webrtc.answering){Webrtc.answering=false;}else{Webrtc.hangup();}},notifyClick:function(){Webrtc.answering=true;Webrtc.answer();Webrtc.notification.close();}});this.notification.show();}}
$.each(this.callBinds,function(i,v){Webrtc.activeCalls[Webrtc.activeCallId].on(v,function(e){if(v=="progress"&&webrtcDetectedType=="webkit"){e.body=null;}
Webrtc.sessionEvent(v,e);});});},sessionEvent:function(type,event){console.log("Session "+type);switch(type){case"failed":this.endCall(event);UCP.removeGlobalMessage();break;case"ended":this.endCall(event);UCP.removeGlobalMessage();break;case"confirmed":case"started":break;case"addstream":this.startCall(event);break;case"connecting":case"progress":this.switchState("progress");break;}},endCall:function(event){this.activeCalls[this.activeCallId]=null;this.activeCallId=null;if(!this.stick){UCP.removePhone(this.windowId);this.windowId=null;}else{this.switchState();}
if(this.notification!==null){this.notification.close();}
if(typeof event.cause!=="undefined"&&event.cause=="User Denied Media Access"){this.userBlocked=true;}
$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .btn-primary[data-type=\"call\"]").prop("disabled",false);this.stopRing();},startCall:function(event){var stream=event.stream;$("#audio_remote").prop("src",window.URL.createObjectURL(stream));this.switchState("hangup");if(this.notification!==null){this.notification.close();}
this.stopRing();},call:function(number){if(this.phone.isConnected()&&!this.userBlocked){$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .btn-primary[data-type=\"call\"]").prop("disabled",true);this.phone.call(number,this.callOptions);}else if(this.phone.isConnected()&&this.userBlocked){alert(_("Unable to start call. Please allow the WebRTC session in your browser and refresh"));}},answer:function(){if(this.activeCallId!==null){this.answering=true;this.switchState("connecting");this.activeCalls[this.activeCallId].answer(this.callOptions);}},toggleHold:function(){if(this.activeCallId!==null){var call=this.activeCalls[this.activeCallId],holds=this.activeCalls[this.activeCallId].isOnHold(),button=$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .window button.secondaction");if(!holds.local){button.removeClass().addClass("btn btn-warning secondaction");button.text("Unhold");call.hold();}else{button.removeClass().addClass("btn btn-success secondaction");button.text("Hold");call.unhold();}}},sendDTMF:function(num){if(this.activeCallId!==null){this.activeCalls[this.activeCallId].sendDTMF(num);}},hangup:function(){if(this.activeCallId!==null){this.activeCalls[this.activeCallId].terminate();}
this.stopRing();},poll:function(data){},display:function(event){},hide:function(event){},switchState:function(t){var button=$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .window button.action"),secondbutton=$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .window button.secondaction"),input=$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .window input.dialpad"),type=(typeof t!=="undefined")?t:"call";button.data("type",type);switch(type){case"connecting":this.stopRing();$(".contactInfo span").text("Connecting Please Wait...");$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .activeCallSession").hide();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .contactDisplay").show();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .window .actions .right").hide();input.prop("disabled",true);button.prop("disabled",false);button.removeClass().addClass("btn btn-danger action").text("Hangup");break;case"progress":this.playRing();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .activeCallSession").hide();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .contactDisplay").show();input.prop("disabled",true);button.prop("disabled",false);button.removeClass().addClass("btn btn-danger action").text("Hangup");break;case"answer":this.playRing();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .activeCallSession").hide();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .contactDisplay").show();secondbutton.removeClass().addClass("btn btn-danger secondaction").text("Ignore");$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .window .actions .right").show();input.prop("disabled",true);button.prop("disabled",false);button.removeClass().addClass("btn btn-success action").text("Answer");break;case"hangup":this.stopRing();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .activeCallSession").show();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .contactDisplay").hide();secondbutton.removeClass().addClass("btn btn-success secondaction").text("Hold");$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .window .actions .right").show();input.prop("disabled",false);button.prop("disabled",false);button.removeClass().addClass("btn btn-danger action").text("Hangup");break;default:this.stopRing();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .activeCallSession").show();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .contactDisplay").hide();$("#messages-container .phone-box[data-id=\""+this.windowId+"\"] .window .actions .right").hide();input.prop("disabled",false);button.prop("disabled",true);button.removeClass().addClass("btn btn-primary action").text("Call");break;}},connect:function(){if((typeof this.staticsettings!=="undefined")&&this.staticsettings.enabled&&Modernizr.getusermedia&&this.disconnected){this.phone.start();}},disconnect:function(){this.disconnected=true;if(this.phone!==null&&this.phone.isConnected()){this.phone.stop();}},originate:function(){if($("#originateTo").val()!==null&&$("#originateTo").val()[0]===""){alert(_("Nothing Entered"));return;}
$.post("index.php?quietmode=1&module=webrtc&command=originate",{from:$("#originateFrom").val(),to:$("#originateTo").val()[0]},function(data){if(data.status){UCP.closeDialog();}});},initiateLibrary:function(){var $this=this,ver="0.6.18";$.getScript("modules/Webrtc/assets/jssiplibs/jssip-"+ver+".js").done(function(script,textStatus){$("#nav-btn-webrtc").removeClass("hidden");UCP.calibrateMenus();$("#footer").append("<audio id=\"audio_remote\" autoplay=\"autoplay\" />");$("#footer").append("<audio id=\"ringtone\"><source src=\"modules/Webrtc/assets/sounds/ring.mp3\" type=\"audio/mpeg\"></audio>");$this.phone=new JsSIP.UA({"ws_servers":$this.staticsettings.settings.wsservers,"uri":$this.staticsettings.settings.uri,"password":$this.staticsettings.settings.password,"log":$this.staticsettings.settings.log});var binds=["connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage","connecting"];$.each(binds,function(i,v){$this.phone.on(v,function(e){$this.engineEvent(v,e);});});$this.phone.start();}).fail(function(jqxhr,settings,exception){});}});$(document).bind("staticSettingsFinished",function(event){if((typeof UCP.Modules.Webrtc.staticsettings!=="undefined")&&UCP.Modules.Webrtc.staticsettings.enabled){$.getScript("modules/Webrtc/assets/jssiplibs/adapter.js").done(function(script,textStatus){if(AdapterJS.onwebrtcreadyDone&&(webrtcDetectedType=="webkit"||webrtcDetectedType=="moz")){UCP.Modules.Webrtc.initiateLibrary();}else{AdapterJS.onwebrtcready=function(isUsingPlugin){UCP.Modules.Webrtc.initiateLibrary();};}}).fail(function(jqxhr,settings,exception){});}});$(document).bind("logIn",function(event){$("#webrtc-menu li.web").on("click",function(){UCP.Modules.Webrtc.setPhone(true);});$("#settings-menu a.originate").on("click",function(){var sfrom="";$.each(UCP.Modules.Webrtc.staticsettings.extensions,function(i,v){sfrom=sfrom+"<option>"+v+"</option>";});UCP.showDialog(_("Originate Call"),"<label for=\"originateFrom\">From:</label> <select id=\"originateFrom\" class=\"form-control\">"+sfrom+"</select><label for=\"originateTo\">To:</label><select class=\"form-control Tokenize Fill\" id=\"originateTo\" multiple></select><button class=\"btn btn-default\" id=\"originateCall\" style=\"margin-left: 72px;\">"+_("Originate")+"</button>",200,250,function(){$("#originateTo").tokenize({maxElements:1,datas:"index.php?quietmode=1&module=webrtc&command=contacts"});$("#originateCall").click(function(){setTimeout(function(){UCP.Modules.Webrtc.originate();},50);});$("#originateTo").keypress(function(event){if(event.keyCode==13){setTimeout(function(){UCP.Modules.Webrtc.originate();},50);}});});});});$(document).bind("phoneWindowRemoved",function(event){UCP.Modules.Webrtc.stick=false;this.windowId=null;UCP.Modules.Webrtc.hangup();});$(document).bind("phoneWindowAdded",function(event){$("#messages-container .phone-box .keypad td").click(function(){var text=$(".phone-box .dialpad").val()+$(this).data("num"),button=$(this).parents(".window").find("button.action");if(button.data("type")=="call"||button.data("type")=="hangup"){if(button.data("type")=="call"){$("#messages-container .phone-box[data-id=\""+UCP.Modules.Webrtc.windowId+"\"] .message").text("To: "+text);}
$("#messages-container .phone-box .dialpad").val(text);UCP.Modules.Webrtc.sendDTMF($(this).data("num"));button.prop("disabled",false);$("#messages-container .phone-box .message-container").textfill();}});$("#messages-container .phone-box .clear-input").click(function(){var button=$(this).parents(".window").find("button.action");$("#messages-container .phone-box .dialpad").val("");if(button.data("type")=="call"){$("#messages-container .phone-box[data-id=\""+UCP.Modules.Webrtc.windowId+"\"] .message").text("");button.prop("disabled",true);}});$("#messages-container .phone-box .dialpad").keyup(function(){var button=$(this).parents(".window").find("button.action"),text=$(".phone-box .dialpad").val();if($(this).val().length===0&&(button.data("type")=="call")){$("#messages-container .phone-box[data-id=\""+UCP.Modules.Webrtc.windowId+"\"] .message").text("");button.prop("disabled",true);}else{$("#messages-container .phone-box[data-id=\""+UCP.Modules.Webrtc.windowId+"\"] .message").text("To: "+text);UCP.Modules.Webrtc.sendDTMF(text.slice(-1));button.prop("disabled",false);}
$("#messages-container .phone-box .message-container").textfill();});$("#messages-container .phone-box button.action").click(function(){var type=$(this).data("type"),num=$("#messages-container .phone-box .dialpad").val();switch(type){case"call":UCP.Modules.Webrtc.call(num);break;case"progress":case"hangup":UCP.Modules.Webrtc.hangup();break;case"answer":UCP.Modules.Webrtc.answer();break;}});$("#messages-container .phone-box button.secondaction").click(function(){var type=$("#messages-container .phone-box button.action").data("type");switch(type){case"hangup":UCP.Modules.Webrtc.toggleHold();break;case"answer":UCP.Modules.Webrtc.hangup();break;}});$("#messages-container .phone-box .message-container").textfill();});$(document).bind("logOut",function(event){if(typeof UCP.Modules.Webrtc!=="undefined"&&UCP.Modules.Webrtc.phone!==null&&UCP.Modules.Webrtc.phone.isConnected()){UCP.Modules.Webrtc.phone.stop();}});$(window).bind("beforeunload",function(){if(typeof UCP.Modules.Webrtc!=="undefined"&&UCP.Modules.Webrtc.phone!==null&&UCP.Modules.Webrtc.phone.isConnected()){UCP.Modules.Webrtc.phone.stop();}});